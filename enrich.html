<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pages Turned - Enrich Books</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Inter', system-ui, sans-serif; background: #faf9f7; color: #2D3E50; padding: 32px; max-width: 800px; margin: 0 auto; }
    h1 { font-size: 1.4rem; margin-bottom: 8px; }
    .subtitle { color: #888; margin-bottom: 24px; }
    .btn { padding: 10px 20px; background: #2D3E50; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-family: inherit; }
    .btn:hover { background: #3d4e60; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-danger { background: #c44; }
    .btn-danger:hover { background: #a33; }
    .buttons { display: flex; gap: 12px; margin-bottom: 24px; }
    #log { background: #fff; border: 1px solid #e8e6e3; border-radius: 8px; padding: 16px; font-family: monospace; font-size: 13px; line-height: 1.8; white-space: pre-wrap; max-height: 600px; overflow-y: auto; }
    .updated { color: #2E7D32; }
    .skipped { color: #888; }
    .error { color: #c44; }
    .info { color: #2D3E50; font-weight: 600; }
  </style>
</head>
<body>
  <h1>Enrich Books</h1>
  <p class="subtitle">Overwrites Amazon URL, cover, and page count for all books without reviews using Open Library API.</p>
  <div class="buttons">
    <button class="btn" onclick="run(true)">Dry Run (Preview)</button>
    <button class="btn btn-danger" onclick="run(false)">Live Run (Save Changes)</button>
  </div>
  <div id="log">Click "Dry Run" to preview changes.</div>

  <script>
    const ADMIN_KEY = 'CV!vxUCQvr*p47xNX@ZB';
    const AFFILIATE_TAG = 'pagesturned-20';
    const logEl = document.getElementById('log');

    function log(msg, cls = '') {
      const span = document.createElement('span');
      span.className = cls;
      span.textContent = msg + '\n';
      logEl.appendChild(span);
      logEl.scrollTop = logEl.scrollHeight;
    }

    function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

    // Convert ISBN-13 to ISBN-10 mathematically
    // ISBN-13: 978-X-XXX-XXXXX-X â†’ take digits 4-12, compute new check digit
    function isbn13to10(isbn13) {
      const clean = isbn13.replace(/[^0-9]/g, '');
      if (clean.length !== 13 || !clean.startsWith('978')) return null;
      const digits = clean.slice(3, 12); // 9 digits
      let sum = 0;
      for (let i = 0; i < 9; i++) {
        sum += parseInt(digits[i]) * (10 - i);
      }
      const check = (11 - (sum % 11)) % 11;
      return digits + (check === 10 ? 'X' : String(check));
    }

    // Look up book via Open Library
    async function lookupByISBN(isbn) {
      const res = await fetch(`https://openlibrary.org/api/books?bibkeys=ISBN:${isbn}&format=json&jscmd=data`);
      const data = await res.json();
      const entry = data[`ISBN:${isbn}`];
      if (!entry) return null;
      return {
        pageCount: entry.number_of_pages || null,
        cover: entry.cover?.medium || entry.cover?.large || null,
        isbn10: null // We'll compute this separately
      };
    }

    // Search Open Library by title + author
    async function searchByTitle(title, author) {
      let q = encodeURIComponent(title);
      if (author) q += '+' + encodeURIComponent(author);
      const res = await fetch(`https://openlibrary.org/search.json?q=${q}&limit=3`);
      const data = await res.json();
      if (!data.docs?.length) return null;

      // Find best match
      const norm = t => (t || '').toLowerCase().replace(/[^a-z0-9]/g, '');
      const target = norm(title);
      const match = data.docs.find(d => {
        const t = norm(d.title);
        return t.includes(target) || target.includes(t);
      }) || data.docs[0];

      // Get ISBN from search results
      const isbn13 = match.isbn?.find(i => i.length === 13 && i.startsWith('978')) || null;
      const isbn10 = match.isbn?.find(i => i.length === 10) || null;
      const coverId = match.cover_i;

      return {
        pageCount: match.number_of_pages_median || null,
        cover: coverId ? `https://covers.openlibrary.org/b/id/${coverId}-M.jpg` : null,
        isbn13,
        isbn10,
        foundTitle: match.title
      };
    }

    async function run(dryRun) {
      logEl.innerHTML = '';
      document.querySelectorAll('.btn').forEach(b => b.disabled = true);

      try {
        log(dryRun ? '=== DRY RUN ===' : '=== LIVE RUN ===', 'info');
        log('Fetching books...');

        const res = await fetch('/api/books');
        const data = await res.json();
        const books = data.books || [];

        const toEnrich = books.filter(b => !b.review?.trim());
        log(`Total: ${books.length} | With reviews (skip): ${books.length - toEnrich.length} | To enrich: ${toEnrich.length}`, 'info');
        log('---');

        let updated = 0, noMatch = 0;

        for (let i = 0; i < toEnrich.length; i++) {
          const book = toEnrich[i];
          log(`[${i + 1}/${toEnrich.length}] "${book.title}"`, 'skipped');

          let result = null;
          let isbn10 = null;

          // Try ISBN lookup first
          if (book.isbn?.trim()) {
            result = await lookupByISBN(book.isbn.trim());
            isbn10 = isbn13to10(book.isbn.trim());
          }

          // Fallback to title search
          if (!result) {
            const search = await searchByTitle(book.title, book.author);
            if (search) {
              result = search;
              isbn10 = search.isbn10 || (search.isbn13 ? isbn13to10(search.isbn13) : null);
              if (!isbn10 && search.isbn10) isbn10 = search.isbn10;
            }
          }

          if (!result) {
            log(`  [NO MATCH]`, 'error');
            noMatch++;
            await sleep(500);
            continue;
          }

          const changes = [];

          // Amazon URL from ISBN-10 (= ASIN for books)
          const asin = isbn10 || book.asin;
          if (asin) {
            const newUrl = `https://www.amazon.com/dp/${asin}?tag=${AFFILIATE_TAG}`;
            if (!dryRun) { book.amazonUrl = newUrl; book.asin = asin; }
            changes.push(`amazon (${asin})`);
          }

          // Cover
          if (result.cover) {
            if (!dryRun) book.cover = result.cover;
            changes.push('cover');
          }

          // Page count
          if (result.pageCount) {
            if (!dryRun) book.pageCount = result.pageCount;
            changes.push(`pages (${result.pageCount})`);
          }

          // Backfill ISBN
          if (!book.isbn?.trim() && result.isbn13) {
            if (!dryRun) book.isbn = result.isbn13;
            changes.push(`isbn (${result.isbn13})`);
          }

          if (changes.length > 0) {
            log(`  [UPDATED] ${changes.join(', ')}`, 'updated');
            updated++;
          } else {
            log(`  [NO DATA] Open Library had no useful fields`, 'error');
            noMatch++;
          }

          await sleep(500);
        }

        log('---');
        log(`Updated: ${updated} | No match/no data: ${noMatch}`, 'info');

        if (!dryRun && updated > 0) {
          log('Saving to KV...');
          await fetch('/api/books', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${ADMIN_KEY}` },
            body: JSON.stringify({ books })
          });
          log('Done! Data saved.', 'info');
        } else if (dryRun && updated > 0) {
          log('Dry run complete. Click "Live Run" to save changes.', 'info');
        } else {
          log('Nothing to update.', 'info');
        }
      } catch (err) {
        log(`Fatal error: ${err.message}`, 'error');
      }

      document.querySelectorAll('.btn').forEach(b => b.disabled = false);
    }
  </script>
</body>
</html>
