<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Reading Journal</title>
  <link href="https://fonts.googleapis.com/css2?family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Inter', system-ui, sans-serif; background: #faf9f7; color: #2d2d2d; line-height: 1.6; }
    .container { max-width: 800px; margin: 0 auto; padding: 24px; }
    header { padding: 48px 24px 32px; text-align: center; border-bottom: 1px solid #e8e6e3; }
    h1 { font-family: 'Libre Baskerville', serif; font-size: 2.2rem; font-weight: 400; margin-bottom: 8px; }
    .subtitle { color: #666; font-size: 0.95rem; }
    nav { margin-top: 24px; display: flex; justify-content: center; gap: 8px; flex-wrap: wrap; }
    nav a { color: #2d2d2d; text-decoration: none; font-size: 0.9rem; padding: 8px 16px; border-radius: 20px; border: 1px solid #e8e6e3; transition: all 0.2s; }
    nav a:hover, nav a.active { background: #2d2d2d; color: #fff; border-color: #2d2d2d; }
    .btn { padding: 10px 20px; background: #2d2d2d; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-family: inherit; }
    .btn:hover { background: #444; }
    .btn-secondary { background: #f5f5f5; color: #2d2d2d; border: 1px solid #ddd; }
    .btn-secondary:hover { background: #eee; }
    .btn-danger { background: #fff; color: #c44; border: 1px solid #ddd; }
    .btn-danger:hover { background: #fef5f5; }
    .btn-small { padding: 6px 12px; font-size: 12px; }
    input, textarea { width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; font-family: inherit; }
    input:focus, textarea:focus { outline: none; border-color: #999; }
    label { font-size: 14px; color: #666; display: block; margin-bottom: 6px; }
    .form-group { margin-bottom: 16px; }
    .form-row { display: grid; grid-template-columns: 1fr 100px; gap: 16px; }
    .card { background: #fff; border: 1px solid #e8e6e3; border-radius: 8px; padding: 24px; margin-bottom: 16px; }
    .book-card { display: flex; gap: 16px; padding: 16px; }
    .book-cover { width: 70px; height: 105px; background: #eee; border-radius: 4px; flex-shrink: 0; overflow: hidden; display: flex; align-items: center; justify-content: center; }
    .book-cover img { width: 100%; height: 100%; object-fit: cover; }
    .book-cover-placeholder { color: #aaa; font-size: 10px; text-align: center; }
    .book-info { flex: 1; min-width: 0; }
    .book-title { font-family: 'Libre Baskerville', serif; font-size: 1.1rem; margin-bottom: 4px; }
    .book-author { color: #666; font-size: 0.9rem; margin-bottom: 6px; }
    .book-review { font-size: 0.9rem; color: #555; margin-top: 8px; }
    .book-actions { display: flex; flex-direction: column; gap: 8px; }
    .top-bar { display: flex; justify-content: flex-end; margin-bottom: 24px; padding-top: 8px; }
    .back-link { background: none; border: none; cursor: pointer; color: #666; font-size: 14px; margin-bottom: 24px; padding: 0; font-family: inherit; }
    .back-link:hover { color: #2d2d2d; }
    .isbn-row { display: flex; gap: 8px; }
    .isbn-row input { flex: 1; }
    .divider { border: none; border-top: 1px solid #eee; margin: 24px 0; }
    .cover-preview { text-align: center; margin-bottom: 20px; }
    .cover-preview img { height: 150px; border-radius: 4px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .rating-input { display: flex; align-items: center; gap: 12px; }
    .rating-input input[type="number"] { width: 80px; }
    .rating-circle { width: 48px; height: 48px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 16px; font-weight: 700; color: #fff; flex-shrink: 0; }
    .rating-circle.no-rating { background: #ccc; }
    .empty-state { text-align: center; padding: 60px 20px; color: #888; }
    .loading { text-align: center; padding: 40px; color: #888; }
    .error { color: #c44; font-size: 13px; margin-top: 8px; }
    .stats { display: grid; grid-template-columns: repeat(3, 1fr); text-align: center; gap: 16px; margin-bottom: 32px; }
    .stat-number { font-family: 'Libre Baskerville', serif; font-size: 2rem; color: #2d2d2d; }
    .stat-label { font-size: 0.75rem; color: #888; text-transform: uppercase; letter-spacing: 0.05em; }
    .book-list { display: flex; flex-direction: column; gap: 12px; }
    @media (max-width: 600px) {
      .form-row { grid-template-columns: 1fr; }
      .book-card { flex-direction: column; }
      .book-actions { flex-direction: row; }
      .stats { grid-template-columns: 1fr; gap: 8px; }
      nav { gap: 6px; }
      nav a { padding: 6px 12px; font-size: 0.8rem; }
    }
  </style>
</head>
<body>
  <div id="app"></div>
  
  <script>
    let books = [];
    let currentView = 'list';
    let currentYear = 'all';
    let editingBook = null;
    let formData = { title: '', author: '', year: '', cover: '', rating: null, review: '', dateRead: '', isbn: '' };
    let isbnInput = '';
    let loading = true;
    let saving = false;
    let error = '';
    let csvText = '';

    const defined_years = ['2025', '2024', '2023', '2022', '2021', '2020', 'older'];

    function openImport() {
      currentView = 'import';
      render();
    }

    function parseCSV(text) {
      const lines = text.split('\n');
      const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
      const result = [];
      
      for (let i = 1; i < lines.length; i++) {
        if (!lines[i].trim()) continue;
        const values = [];
        let current = '';
        let inQuotes = false;
        
        for (let char of lines[i]) {
          if (char === '"') {
            inQuotes = !inQuotes;
          } else if (char === ',' && !inQuotes) {
            values.push(current.trim());
            current = '';
          } else {
            current += char;
          }
        }
        values.push(current.trim());
        
        const row = {};
        headers.forEach((h, idx) => {
          row[h] = (values[idx] || '').replace(/^="?|"$/g, '').replace(/""/g, '"');
        });
        result.push(row);
      }
      return result;
    }

    function importCSV() {
      if (!csvText.trim()) {
        error = 'Please paste your CSV data';
        render();
        return;
      }
      
      try {
        const rows = parseCSV(csvText);
        const imported = [];
        
        rows.forEach((row, idx) => {
          const shelf = row['Exclusive Shelf'] || '';
          if (shelf !== 'read') return;
          
          const dateAdded = row['Date Added'] || '';
          const isbn = (row['ISBN'] || '').replace(/[="]/g, '');
          const year = row['Year Published'] || row['Original Publication Year'] || '';
          
          imported.push({
            id: Date.now() + idx,
            title: row['Title'] || 'Unknown',
            author: row['Author'] || '',
            year: parseInt(year) || 0,
            isbn: isbn,
            cover: isbn ? `https://covers.openlibrary.org/b/isbn/${isbn}-M.jpg` : '',
            rating: null,
            review: '',
            dateRead: dateAdded ? dateAdded.replace(/\//g, '-') : ''
          });
        });
        
        if (imported.length === 0) {
          error = 'No "read" books found in CSV';
          render();
          return;
        }
        
        books = imported;
        saveBooks();
        currentView = 'list';
        csvText = '';
        error = '';
        render();
        alert(`Successfully imported ${imported.length} books!`);
      } catch (e) {
        error = 'Error parsing CSV: ' + e.message;
        render();
      }
    }

    function renderImport() {
      return `
        <div class="container" style="padding-top: 32px;">
          <button class="back-link" onclick="currentView='list';render();">← Back</button>
          <h1 style="font-family: 'Libre Baskerville', serif; font-size: 1.5rem; font-weight: 400; margin-bottom: 24px;">
            Import from Goodreads
          </h1>
          <div class="card">
            <p style="margin-bottom:16px;color:#666;">Paste your Goodreads CSV export below. Only books marked as "read" will be imported, using the "Date Added" field.</p>
            <div class="form-group">
              <label>CSV Data</label>
              <textarea rows="12" placeholder="Paste your CSV here..." oninput="csvText=this.value">${csvText}</textarea>
            </div>
            ${error ? `<p class="error">${error}</p>` : ''}
            <button class="btn" onclick="importCSV()" style="width: 100%;">
              Import Books
            </button>
          </div>
        </div>
      `;
    }

    function getRatingColor(r) {
      if (r === null || r === undefined || r === '') return { bg: '#ccc', shadow: 'rgba(0,0,0,0.1)' };
      if (r >= 90) return { bg: '#2E7D32', shadow: 'rgba(46,125,50,0.3)' };
      if (r >= 70) return { bg: '#66BB6A', shadow: 'rgba(102,187,106,0.3)' };
      if (r >= 50) return { bg: '#FFC107', shadow: 'rgba(255,193,7,0.3)' };
      if (r >= 30) return { bg: '#FF9800', shadow: 'rgba(255,152,0,0.3)' };
      return { bg: '#E53935', shadow: 'rgba(229,57,53,0.3)' };
    }

    function getYearFromDate(dateStr) {
      if (!dateStr) return 'older';
      const year = dateStr.slice(0, 4);
      const yearNum = parseInt(year);
      if (yearNum >= 2020) return year;
      return 'older';
    }

    async function loadBooks() {
      try {
        const res = await fetch('/api/books');
        const data = await res.json();
        books = data.books || [];
      } catch (e) {
        console.error('Failed to load books:', e);
        books = [];
      }
      loading = false;
      render();
    }

    async function saveBooks() {
      saving = true;
      render();
      try {
        await fetch('/api/books', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ books })
        });
      } catch (e) {
        console.error('Failed to save:', e);
      }
      saving = false;
      render();
    }

    async function fetchISBN() {
      if (!isbnInput.trim()) return;
      error = '';
      render();
      
      try {
        const res = await fetch(`https://openlibrary.org/api/books?bibkeys=ISBN:${isbnInput.trim()}&format=json&jscmd=data`);
        const data = await res.json();
        const bookData = data[`ISBN:${isbnInput.trim()}`];
        
        if (bookData) {
          formData.title = bookData.title || formData.title;
          formData.author = bookData.authors?.[0]?.name || formData.author;
          formData.year = bookData.publish_date?.match(/\d{4}/)?.[0] || formData.year;
          formData.cover = `https://covers.openlibrary.org/b/isbn/${isbnInput.trim()}-M.jpg`;
          formData.isbn = isbnInput.trim();
        } else {
          error = 'Book not found. Try a different ISBN.';
        }
      } catch (e) {
        error = 'Failed to fetch book data.';
      }
      render();
    }

    function resetForm() {
      formData = { title: '', author: '', year: '', cover: '', rating: null, review: '', dateRead: '', isbn: '' };
      isbnInput = '';
      error = '';
    }

    function openAdd() {
      resetForm();
      editingBook = null;
      currentView = 'edit';
      render();
    }

    function openEdit(book) {
      formData = { ...book, year: String(book.year || '') };
      isbnInput = book.isbn || '';
      editingBook = book;
      currentView = 'edit';
      render();
    }

    function deleteBook(id) {
      if (confirm('Delete this book review?')) {
        books = books.filter(b => b.id !== id);
        saveBooks();
      }
    }

    function saveBook() {
      if (!formData.title.trim()) {
        error = 'Title is required';
        render();
        return;
      }

      const ratingVal = formData.rating === '' || formData.rating === null ? null : parseInt(formData.rating);

      if (editingBook) {
        books = books.map(b => b.id === editingBook.id ? { ...formData, id: b.id, year: parseInt(formData.year) || 0, rating: ratingVal } : b);
      } else {
        books.push({ ...formData, id: Date.now(), year: parseInt(formData.year) || 0, rating: ratingVal });
      }
      
      saveBooks();
      currentView = 'list';
      resetForm();
      render();
    }

    function goBack() {
      currentView = 'list';
      resetForm();
      render();
    }

    function setYear(year) {
      currentYear = year;
      render();
    }

    function updateForm(field, value) {
      formData[field] = value;
      if (field === 'rating') render();
    }

    function updateIsbn(value) {
      isbnInput = value;
    }

    function renderRatingCircle(rating, size = 48) {
      const colors = getRatingColor(rating);
      const display = rating === null || rating === undefined || rating === '' ? '—' : rating;
      return `<div class="rating-circle" style="width:${size}px;height:${size}px;background:${colors.bg};box-shadow:0 3px 10px ${colors.shadow};font-size:${size * 0.33}px;">${display}</div>`;
    }

    function getFilteredBooks() {
      if (currentYear === 'all') return books;
      if (currentYear === 'rankings') return [...books].filter(b => b.rating !== null).sort((a, b) => (b.rating || 0) - (a.rating || 0));
      return books.filter(b => getYearFromDate(b.dateRead) === currentYear);
    }

    function renderNav() {
      const tabs = [
        { id: 'all', label: 'All' },
        { id: '2025', label: '2025' },
        { id: '2024', label: '2024' },
        { id: '2023', label: '2023' },
        { id: '2022', label: '2022' },
        { id: '2021', label: '2021' },
        { id: '2020', label: '2020' },
        { id: 'older', label: 'Older' },
        { id: 'rankings', label: 'All-Time Rankings' }
      ];
      return `<nav>${tabs.map(t => `<a href="#" class="${currentYear === t.id ? 'active' : ''}" onclick="event.preventDefault();setYear('${t.id}')">${t.label}</a>`).join('')}</nav>`;
    }

    function renderList() {
      if (loading) {
        return '<div class="loading">Loading your books...</div>';
      }

      const filteredBooks = getFilteredBooks();
      const ratedBooks = books.filter(b => b.rating !== null);
      const avgRating = ratedBooks.length ? (ratedBooks.reduce((sum, b) => sum + (b.rating || 0), 0) / ratedBooks.length).toFixed(0) : '—';

      let html = `
        <header>
          <h1>Reading Journal</h1>
          <p class="subtitle">${books.length} book${books.length !== 1 ? 's' : ''} reviewed</p>
          ${renderNav()}
        </header>
        <div class="container">
          <div class="top-bar">
            <button class="btn" onclick="openAdd()">+ Add Book</button>
            <button class="btn btn-secondary" onclick="openImport()" style="margin-left:8px;">Import CSV</button>
          </div>
      `;

      if (currentYear === 'rankings') {
        html += `<h2 style="font-family:'Libre Baskerville',serif;font-size:1.3rem;font-weight:400;margin-bottom:20px;">All-Time Rankings</h2>`;
        if (filteredBooks.length === 0) {
          html += '<div class="empty-state"><p>No rated books yet. Add ratings to see your rankings!</p></div>';
        } else {
          html += '<div class="book-list">';
          filteredBooks.forEach((book, index) => {
            html += renderBookCard(book, index + 1);
          });
          html += '</div>';
        }
      } else if (currentYear === 'all') {
        if (books.length > 0) {
          html += `
            <div class="card stats">
              <div>
                <div class="stat-number">${books.length}</div>
                <div class="stat-label">Books Read</div>
              </div>
              <div>
                <div class="stat-number">${avgRating}</div>
                <div class="stat-label">Avg Rating</div>
              </div>
              <div>
                <div class="stat-number">${ratedBooks.filter(b => b.rating >= 90).length}</div>
                <div class="stat-label">Top Rated (90+)</div>
              </div>
            </div>
          `;

          const grouped = {};
          books.forEach(book => {
            const year = getYearFromDate(book.dateRead);
            if (!grouped[year]) grouped[year] = [];
            grouped[year].push(book);
          });

          defined_years.forEach(year => {
            if (grouped[year] && grouped[year].length > 0) {
              const sorted = [...grouped[year]].sort((a, b) => (b.rating || 0) - (a.rating || 0));
              const label = year === 'older' ? 'Older' : year;
              html += `<h2 style="font-family:'Libre Baskerville',serif;font-size:1.2rem;font-weight:400;margin:32px 0 16px;padding-bottom:8px;border-bottom:1px solid #e8e6e3;">${label}</h2>`;
              html += '<div class="book-list">';
              sorted.forEach(book => {
                html += renderBookCard(book);
              });
              html += '</div>';
            }
          });
        } else {
          html += '<div class="empty-state"><p>No books yet. Add your first review!</p></div>';
        }
      } else {
        const label = currentYear === 'older' ? 'Older' : currentYear;
        html += `<h2 style="font-family:'Libre Baskerville',serif;font-size:1.3rem;font-weight:400;margin-bottom:20px;">${label}</h2>`;
        if (filteredBooks.length === 0) {
          html += `<div class="empty-state"><p>No books for ${label}.</p></div>`;
        } else {
          const sorted = [...filteredBooks].sort((a, b) => (b.rating || 0) - (a.rating || 0));
          html += '<div class="book-list">';
          sorted.forEach(book => {
            html += renderBookCard(book);
          });
          html += '</div>';
        }
      }

      html += '</div>';
      return html;
    }

    function renderBookCard(book, rank = null) {
      return `
        <div class="card book-card">
          <div class="book-cover">
            ${book.cover 
              ? `<img src="${book.cover}" alt="" onerror="this.parentElement.innerHTML='<span class=\\'book-cover-placeholder\\'>No cover</span>'">`
              : '<span class="book-cover-placeholder">No cover</span>'}
          </div>
          <div class="book-info">
            <h3 class="book-title">${rank ? `<span style="color:#888;font-family:Inter,sans-serif;font-size:0.9rem;margin-right:8px;">#${rank}</span>` : ''}${book.title}</h3>
            <p class="book-author">${book.author || 'Unknown author'}${book.year ? ` (${book.year})` : ''}</p>
            ${book.review ? `<p class="book-review">${book.review}</p>` : ''}
          </div>
          ${renderRatingCircle(book.rating)}
          <div class="book-actions">
            <button class="btn btn-secondary btn-small" onclick="openEdit(books.find(b => b.id === ${book.id}))">Edit</button>
            <button class="btn btn-danger btn-small" onclick="deleteBook(${book.id})">Delete</button>
          </div>
        </div>
      `;
    }

    function renderEdit() {
      const previewColors = getRatingColor(formData.rating);
      return `
        <div class="container" style="padding-top: 32px;">
          <button class="back-link" onclick="goBack()">← Back to all books</button>
          <h1 style="font-family: 'Libre Baskerville', serif; font-size: 1.5rem; font-weight: 400; margin-bottom: 24px;">
            ${editingBook ? 'Edit Review' : 'Add New Book'}
          </h1>
          <div class="card">
            <div class="form-group">
              <label>Import from ISBN</label>
              <div class="isbn-row">
                <input type="text" value="${isbnInput}" oninput="updateIsbn(this.value)" placeholder="e.g. 9780593321201">
                <button class="btn" onclick="fetchISBN()">Fetch</button>
              </div>
              ${error ? `<p class="error">${error}</p>` : ''}
            </div>
            
            <hr class="divider">
            
            ${formData.cover ? `<div class="cover-preview"><img src="${formData.cover}" alt="Cover" onerror="this.style.display='none'"></div>` : ''}
            
            <div class="form-group">
              <label>Title *</label>
              <input type="text" value="${formData.title}" oninput="updateForm('title', this.value)">
            </div>
            
            <div class="form-row">
              <div class="form-group">
                <label>Author</label>
                <input type="text" value="${formData.author}" oninput="updateForm('author', this.value)">
              </div>
              <div class="form-group">
                <label>Year</label>
                <input type="text" value="${formData.year}" oninput="updateForm('year', this.value)">
              </div>
            </div>
            
            <div class="form-group">
              <label>Cover Image URL</label>
              <input type="text" value="${formData.cover}" oninput="updateForm('cover', this.value)" placeholder="https://...">
            </div>
            
            <div class="form-group">
              <label>Date Read</label>
              <input type="date" value="${formData.dateRead}" oninput="updateForm('dateRead', this.value)" style="width: auto;">
            </div>
            
            <div class="form-group">
              <label>Rating (1-100)</label>
              <div class="rating-input">
                <input type="number" min="1" max="100" value="${formData.rating || ''}" oninput="updateForm('rating', this.value)" placeholder="—">
                ${renderRatingCircle(formData.rating, 40)}
              </div>
            </div>
            
            <div class="form-group">
              <label>Review</label>
              <textarea rows="5" oninput="updateForm('review', this.value)">${formData.review || ''}</textarea>
            </div>
            
            <button class="btn" onclick="saveBook()" style="width: 100%;">
              ${saving ? 'Saving...' : (editingBook ? 'Save Changes' : 'Add Book')}
            </button>
          </div>
        </div>
      `;
    }

    function render() {
      const app = document.getElementById('app');
      if (currentView === 'list') {
        app.innerHTML = renderList();
      } else if (currentView === 'edit') {
        app.innerHTML = renderEdit();
      } else if (currentView === 'import') {
        app.innerHTML = renderImport();
      }
    }

    loadBooks();
  </script>
</body>
</html>
