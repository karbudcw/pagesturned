<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Book Year</title>
  <link href="https://fonts.googleapis.com/css2?family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Inter', system-ui, sans-serif; background: #faf9f7; color: #2d2d2d; line-height: 1.6; }
    .container { max-width: 900px; margin: 0 auto; padding: 24px; }
    header { padding: 40px 24px 24px; text-align: center; border-bottom: 1px solid #e8e6e3; }
    h1 { font-family: 'Libre Baskerville', serif; font-size: 2rem; font-weight: 400; margin-bottom: 8px; }
    .subtitle { color: #666; font-size: 0.95rem; }
    nav { display: flex; justify-content: center; flex-wrap: wrap; gap: 8px; margin-top: 20px; }
    nav button { background: none; border: 1px solid #ddd; padding: 8px 16px; border-radius: 20px; cursor: pointer; font-size: 14px; font-family: inherit; transition: all 0.2s; }
    nav button:hover { border-color: #999; }
    nav button.active { background: #2d2d2d; color: #fff; border-color: #2d2d2d; }
    .btn { padding: 10px 20px; background: #2d2d2d; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-family: inherit; }
    .btn:hover { background: #444; }
    .btn-secondary { background: #f5f5f5; color: #2d2d2d; border: 1px solid #ddd; }
    .btn-secondary:hover { background: #eee; }
    .btn-danger { background: #fff; color: #c44; border: 1px solid #ddd; }
    .btn-small { padding: 6px 12px; font-size: 12px; }
    input, textarea, select { padding: 10px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; font-family: inherit; }
    input:focus, textarea:focus, select:focus { outline: none; border-color: #999; }
    label { font-size: 14px; color: #666; display: block; margin-bottom: 6px; }
    .form-group { margin-bottom: 16px; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .card { background: #fff; border: 1px solid #e8e6e3; border-radius: 8px; padding: 20px; margin-bottom: 12px; }
    .book-card { display: flex; gap: 16px; }
    .book-cover { width: 65px; height: 100px; background: #eee; border-radius: 4px; flex-shrink: 0; overflow: hidden; }
    .book-cover img { width: 100%; height: 100%; object-fit: cover; }
    .book-info { flex: 1; min-width: 0; }
    .book-title { font-family: 'Libre Baskerville', serif; font-size: 1rem; margin-bottom: 4px; }
    .book-title a { color: inherit; text-decoration: none; }
    .book-title a:hover { text-decoration: underline; }
    .book-author { color: #666; font-size: 0.85rem; margin-bottom: 4px; }
    .book-meta { display: flex; align-items: center; gap: 8px; margin-bottom: 4px; }
    .format-icon { font-size: 14px; }
    .read-date { font-size: 12px; color: #999; }
    .book-review { font-size: 0.85rem; color: #555; margin-top: 8px; }
    .book-actions { display: flex; gap: 8px; align-items: flex-start; }
    .rating-circle { width: 44px; height: 44px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: 700; color: #fff; flex-shrink: 0; }
    .rating-unrated { background: #ccc; font-size: 11px; }
    .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; padding-top: 16px; flex-wrap: wrap; gap: 12px; }
    .back-link { background: none; border: none; cursor: pointer; color: #666; font-size: 14px; padding: 0; font-family: inherit; }
    .back-link:hover { color: #2d2d2d; }
    .empty-state { text-align: center; padding: 60px 20px; color: #888; }
    .loading { text-align: center; padding: 40px; color: #888; }
    .error { color: #c44; font-size: 13px; margin-top: 8px; }
    .stats { display: grid; grid-template-columns: repeat(4, 1fr); text-align: center; gap: 16px; margin-bottom: 24px; }
    .stat-number { font-family: 'Libre Baskerville', serif; font-size: 1.75rem; color: #2d2d2d; }
    .stat-label { font-size: 0.7rem; color: #888; text-transform: uppercase; letter-spacing: 0.05em; }
    .section-title { font-size: 1rem; font-weight: 500; margin-bottom: 16px; padding-bottom: 8px; border-bottom: 1px solid #e8e6e3; }
    .import-section { margin-top: 24px; padding: 20px; background: #fff; border: 1px solid #e8e6e3; border-radius: 8px; }
    .import-section textarea { width: 100%; height: 150px; margin: 12px 0; }
    .book-rank { font-size: 14px; color: #999; margin-right: 12px; min-width: 30px; }
    .format-select { display: flex; gap: 12px; }
    .format-option { display: flex; align-items: center; gap: 6px; cursor: pointer; padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; transition: all 0.2s; }
    .format-option:hover { border-color: #999; }
    .format-option.selected { border-color: #2d2d2d; background: #f5f5f5; }
    .format-option input { display: none; }
    @media (max-width: 600px) {
      .form-row { grid-template-columns: 1fr; }
      .stats { grid-template-columns: repeat(2, 1fr); }
      .book-actions { flex-direction: column; }
      nav { gap: 6px; }
      nav button { padding: 6px 12px; font-size: 13px; }
      .format-select { flex-wrap: wrap; }
    }
  </style>
</head>
<body>
  <div id="app"><div class="loading">Loading...</div></div>
  <script>
    const ADMIN_KEY = 'CV!vxUCQvr*p47xNX@ZB';
    const CURRENT_YEAR = '2026';
    
    let books = [];
    let view = 'list';
    let yearFilter = 'current';
    let editingBook = null;
    let loading = true;
    let error = '';
    
    // Check for admin mode via URL parameter
    const urlParams = new URLSearchParams(window.location.search);
    const isAdmin = urlParams.get('admin') === ADMIN_KEY;

    const getColor = r => {
      if (r === null) return '#ccc';
      if (r >= 90) return '#2E7D32';
      if (r >= 70) return '#66BB6A';
      if (r >= 50) return '#FFC107';
      if (r >= 30) return '#FF9800';
      return '#E53935';
    };

    const getFormatIcon = f => {
      if (f === 'ebook') return 'üì±';
      if (f === 'physical') return 'üìñ';
      if (f === 'audiobook') return 'üéß';
      return '';
    };

    const formatReadDate = d => {
      if (!d) return '';
      const date = new Date(d);
      const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
      const month = months[date.getMonth()];
      const year = String(date.getFullYear()).slice(2);
      return `Read ${month} ${year}`;
    };

    const escapeHtml = str => {
      if (!str) return '';
      return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
    };

    const getYear = d => d ? d.slice(0, 4) : 'Unknown';
    const getYearGroup = d => {
      const y = getYear(d);
      if (!y || y === 'Unknown') return 'Older';
      const n = parseInt(y);
      return n >= 2020 ? y : 'Older';
    };

    async function loadBooks() {
      try {
        const res = await fetch('/api/books');
        const data = await res.json();
        books = data.books || [];
      } catch (e) { books = []; }
      loading = false;
      render();
    }

    async function saveBooks() {
      try {
        const headers = { 'Content-Type': 'application/json' };
        if (isAdmin) {
          headers['Authorization'] = `Bearer ${ADMIN_KEY}`;
        }
        const res = await fetch('/api/books', {
          method: 'POST',
          headers,
          body: JSON.stringify({ books })
        });
        if (!res.ok) {
          const data = await res.json();
          console.error('Save failed:', data.error);
          alert('Save failed: ' + (data.error || 'Unknown error'));
          return;
        }
      } catch (e) { console.error('Save failed:', e); }
      render();
    }

    async function fetchISBN() {
      const isbnInput = document.getElementById('isbnInput').value.trim();
      if (!isbnInput) return;
      error = '';
      try {
        const res = await fetch(`https://openlibrary.org/api/books?bibkeys=ISBN:${isbnInput}&format=json&jscmd=data`);
        const data = await res.json();
        const b = data[`ISBN:${isbnInput}`];
        if (b) {
          document.getElementById('titleInput').value = b.title || '';
          document.getElementById('authorInput').value = b.authors?.[0]?.name || '';
          document.getElementById('yearInput').value = b.publish_date?.match(/\d{4}/)?.[0] || '';
          document.getElementById('coverInput').value = `https://covers.openlibrary.org/b/isbn/${isbnInput}-M.jpg`;
        } else { error = 'Book not found.'; }
      } catch (e) { error = 'Failed to fetch.'; }
      render();
    }

    function openAdd() { editingBook = null; view = 'edit'; error = ''; render(); }
    function openEdit(book) {
      editingBook = book;
      view = 'edit';
      error = '';
      render();
    }
    function deleteBook(id) {
      if (confirm('Delete this book?')) {
        books = books.filter(b => b.id !== id);
        saveBooks();
      }
    }
    
    function getFormData() {
      return {
        title: document.getElementById('titleInput').value,
        author: document.getElementById('authorInput').value,
        year: parseInt(document.getElementById('yearInput').value) || null,
        cover: document.getElementById('coverInput').value,
        dateRead: document.getElementById('dateReadInput').value,
        rating: document.getElementById('ratingInput').value === '' ? null : parseInt(document.getElementById('ratingInput').value),
        format: document.querySelector('input[name="format"]:checked')?.value || '',
        amazonUrl: document.getElementById('amazonUrlInput').value,
        review: document.getElementById('reviewInput').value,
        isbn: document.getElementById('isbnInput').value
      };
    }
    
    function saveBook() {
      const formData = getFormData();
      if (!formData.title.trim()) { error = 'Title required'; render(); return; }
      
      if (editingBook) {
        books = books.map(b => b.id === editingBook.id ? { ...formData, id: b.id } : b);
      } else {
        books.push({ ...formData, id: Date.now() });
      }
      saveBooks();
      view = 'list';
      editingBook = null;
      error = '';
    }
    function goBack() { view = 'list'; editingBook = null; error = ''; render(); }
    function setYear(y) { yearFilter = y; render(); }
    function setView(v) { view = v; render(); }

    function importBooks(json) {
      try {
        const imported = JSON.parse(json);
        if (Array.isArray(imported)) {
          books = imported.map((b, i) => ({ ...b, id: Date.now() + i }));
          saveBooks();
          alert(`Imported ${books.length} books!`);
        }
      } catch (e) { alert('Invalid JSON'); }
    }

    function ratingCircle(r) {
      const color = getColor(r);
      const label = r === null ? '‚Äì' : r;
      const cls = r === null ? 'rating-circle rating-unrated' : 'rating-circle';
      return `<div class="${cls}" style="background:${color};box-shadow:0 3px 10px ${color}44">${label}</div>`;
    }

    function filterBooks() {
      if (yearFilter === 'current') {
        return books.filter(b => getYearGroup(b.dateRead) === CURRENT_YEAR).sort((a,b) => (b.rating||0) - (a.rating||0));
      }
      if (yearFilter === 'alltime') {
        return [...books].filter(b => b.rating !== null).sort((a,b) => b.rating - a.rating);
      }
      return books.filter(b => getYearGroup(b.dateRead) === yearFilter).sort((a,b) => (b.rating||0) - (a.rating||0));
    }

    function getStatsForFilter() {
      let subset;
      if (yearFilter === 'current') {
        subset = books.filter(b => getYearGroup(b.dateRead) === CURRENT_YEAR);
      } else if (yearFilter === 'alltime') {
        subset = books;
      } else {
        subset = books.filter(b => getYearGroup(b.dateRead) === yearFilter);
      }
      const rated = subset.filter(b => b.rating !== null);
      const avg = rated.length ? (rated.reduce((s,b) => s + b.rating, 0) / rated.length).toFixed(0) : '‚Äì';
      const ninety = subset.filter(b => b.rating >= 90).length;
      return { total: subset.length, rated: rated.length, avg, ninety };
    }

    function renderBookTitle(book) {
      const title = escapeHtml(book.title);
      if (book.amazonUrl) {
        return `<a href="${escapeHtml(book.amazonUrl)}" target="_blank" rel="noopener noreferrer">${title}</a>`;
      }
      return title;
    }

    function renderBookMeta(book) {
      const formatIcon = getFormatIcon(book.format);
      const readDate = formatReadDate(book.dateRead);
      if (!formatIcon && !readDate) return '';
      return `<div class="book-meta">
        ${formatIcon ? `<span class="format-icon">${formatIcon}</span>` : ''}
        ${readDate ? `<span class="read-date">${readDate}</span>` : ''}
      </div>`;
    }

    function renderList() {
      if (loading) return '<div class="loading">Loading...</div>';
      const years = ['current', '2025', '2024', '2023', '2022', '2021', '2020', 'Older', 'alltime'];
      const filtered = filterBooks();
      const stats = getStatsForFilter();

      let html = `
        <header>
          <h1>My Book Year</h1>
          <p class="subtitle">${books.length} books</p>
          <nav>
            ${years.map(y => `<button class="${yearFilter === y ? 'active' : ''}" onclick="setYear('${y}')">${y === 'current' ? 'Current' : y === 'alltime' ? 'üèÜ All Time' : y}</button>`).join('')}
          </nav>
        </header>
        <div class="container">
          <div class="top-bar">
            <div></div>
            ${isAdmin ? `<div style="display:flex;gap:8px;">
              <button class="btn btn-secondary" onclick="setView('import')">Import</button>
              <button class="btn" onclick="openAdd()">+ Add Book</button>
            </div>` : ''}
          </div>
          <div class="card stats">
            <div><div class="stat-number">${stats.total}</div><div class="stat-label">Books</div></div>
            <div><div class="stat-number">${stats.rated}</div><div class="stat-label">Rated</div></div>
            <div><div class="stat-number">${stats.avg}</div><div class="stat-label">Avg Rating</div></div>
            <div><div class="stat-number">${stats.ninety}</div><div class="stat-label">90+ Books</div></div>
          </div>`;

      if (yearFilter === 'alltime') {
        html += `<h2 class="section-title">All-Time Rankings</h2>`;
        filtered.forEach((book, i) => {
          html += `<div class="card book-card">
            <div class="book-rank">#${i + 1}</div>
            <div class="book-cover">${book.cover ? `<img src="${escapeHtml(book.cover)}" onerror="this.parentElement.innerHTML=''">` : ''}</div>
            <div class="book-info">
              <div class="book-title">${renderBookTitle(book)}</div>
              <p class="book-author">${escapeHtml(book.author) || ''}${book.year ? ` (${book.year})` : ''}</p>
              ${renderBookMeta(book)}
            </div>
            ${ratingCircle(book.rating)}
          </div>`;
        });
      } else {
        if (filtered.length === 0) {
          html += '<div class="empty-state">No books found.</div>';
        } else {
          filtered.forEach(book => {
            html += `<div class="card book-card">
              <div class="book-cover">${book.cover ? `<img src="${escapeHtml(book.cover)}" onerror="this.parentElement.innerHTML=''">` : ''}</div>
              <div class="book-info">
                <div class="book-title">${renderBookTitle(book)}</div>
                <p class="book-author">${escapeHtml(book.author) || ''}${book.year ? ` (${book.year})` : ''}</p>
                ${renderBookMeta(book)}
                ${book.review ? `<p class="book-review">${escapeHtml(book.review)}</p>` : ''}
              </div>
              ${ratingCircle(book.rating)}
              ${isAdmin ? `<div class="book-actions">
                <button class="btn btn-secondary btn-small" onclick="openEdit(books.find(b=>b.id===${book.id}))">Edit</button>
                <button class="btn btn-danger btn-small" onclick="deleteBook(${book.id})">Delete</button>
              </div>` : ''}
            </div>`;
          });
        }
      }
      html += '</div>';
      return html;
    }

    function renderEdit() {
      const book = editingBook || {};
      return `
        <div class="container" style="padding-top:32px">
          <button class="back-link" onclick="goBack()">‚Üê Back</button>
          <h1 style="font-family:'Libre Baskerville',serif;font-size:1.4rem;font-weight:400;margin:20px 0">${editingBook ? 'Edit Book' : 'Add Book'}</h1>
          <div class="card">
            <div class="form-group">
              <label>Import from ISBN</label>
              <div style="display:flex;gap:8px">
                <input type="text" id="isbnInput" value="${escapeHtml(book.isbn || '')}" placeholder="e.g. 9780593321201" style="flex:1">
                <button class="btn" onclick="fetchISBN()">Fetch</button>
              </div>
              ${error ? `<p class="error">${error}</p>` : ''}
            </div>
            <hr style="border:none;border-top:1px solid #eee;margin:20px 0">
            <div class="form-group">
              <label>Title *</label>
              <input type="text" id="titleInput" value="${escapeHtml(book.title || '')}" style="width:100%">
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>Author</label>
                <input type="text" id="authorInput" value="${escapeHtml(book.author || '')}" style="width:100%">
              </div>
              <div class="form-group">
                <label>Year Published</label>
                <input type="text" id="yearInput" value="${book.year || ''}" style="width:100%">
              </div>
            </div>
            <div class="form-group">
              <label>Cover URL</label>
              <input type="text" id="coverInput" value="${escapeHtml(book.cover || '')}" placeholder="https://..." style="width:100%">
            </div>
            <div class="form-group">
              <label>Amazon URL</label>
              <input type="text" id="amazonUrlInput" value="${escapeHtml(book.amazonUrl || '')}" placeholder="https://amazon.com/..." style="width:100%">
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>Date Read</label>
                <input type="date" id="dateReadInput" value="${book.dateRead || ''}">
              </div>
              <div class="form-group">
                <label>Rating (1-100)</label>
                <input type="number" id="ratingInput" min="1" max="100" value="${book.rating !== null && book.rating !== undefined ? book.rating : ''}" placeholder="Leave blank if unrated">
              </div>
            </div>
            <div class="form-group">
              <label>Format</label>
              <div class="format-select">
                <label class="format-option ${book.format === 'ebook' ? 'selected' : ''}">
                  <input type="radio" name="format" value="ebook" ${book.format === 'ebook' ? 'checked' : ''}>
                  üì± eBook
                </label>
                <label class="format-option ${book.format === 'physical' ? 'selected' : ''}">
                  <input type="radio" name="format" value="physical" ${book.format === 'physical' ? 'checked' : ''}>
                  üìñ Physical
                </label>
                <label class="format-option ${book.format === 'audiobook' ? 'selected' : ''}">
                  <input type="radio" name="format" value="audiobook" ${book.format === 'audiobook' ? 'checked' : ''}>
                  üéß Audiobook
                </label>
              </div>
            </div>
            <div class="form-group">
              <label>Review</label>
              <textarea id="reviewInput" rows="4" style="width:100%">${escapeHtml(book.review || '')}</textarea>
            </div>
            <button class="btn" onclick="saveBook()" style="width:100%">${editingBook ? 'Save Changes' : 'Add Book'}</button>
          </div>
        </div>`;
    }

    function renderImport() {
      return `
        <div class="container" style="padding-top:32px">
          <button class="back-link" onclick="setView('list')">‚Üê Back</button>
          <h1 style="font-family:'Libre Baskerville',serif;font-size:1.4rem;font-weight:400;margin:20px 0">Import Books</h1>
          <div class="card">
            <p style="margin-bottom:12px;color:#666">Paste your books JSON array below. This will replace all existing books.</p>
            <textarea id="importData" placeholder='[{"title":"Book Title","author":"Author Name",...}]' style="width:100%;height:200px;font-family:monospace;font-size:12px"></textarea>
            <button class="btn" onclick="importBooks(document.getElementById('importData').value)" style="margin-top:12px">Import</button>
          </div>
        </div>`;
    }

    function render() {
      const app = document.getElementById('app');
      if (view === 'edit' && isAdmin) app.innerHTML = renderEdit();
      else if (view === 'import' && isAdmin) app.innerHTML = renderImport();
      else app.innerHTML = renderList();
    }

    loadBooks();
  </script>
</body>
</html>
