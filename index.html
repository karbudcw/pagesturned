<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pages Turned</title>
  <link href="https://fonts.googleapis.com/css2?family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Inter', system-ui, sans-serif; background: #faf9f7; color: #2d2d2d; line-height: 1.6; }
    .container { max-width: 900px; margin: 0 auto; padding: 24px; }
    header { padding: 40px 24px 24px; text-align: center; border-bottom: 1px solid #e8e6e3; }
    .logo { margin-bottom: 12px; }
    .logo svg { height: 50px; width: auto; }
    h1 { font-family: 'Libre Baskerville', serif; font-size: 2rem; font-weight: 400; margin-bottom: 8px; }
    .subtitle { color: #666; font-size: 0.95rem; }
    nav { display: flex; justify-content: center; flex-wrap: wrap; gap: 8px; margin-top: 20px; }
    nav button { background: none; border: 1px solid #ddd; padding: 8px 16px; border-radius: 20px; cursor: pointer; font-size: 14px; font-family: inherit; transition: all 0.2s; }
    nav button:hover { border-color: #999; }
    nav button.active { background: #2D3E50; color: #fff; border-color: #2D3E50; }
    .btn { padding: 10px 20px; background: #2D3E50; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-family: inherit; }
    .btn:hover { background: #3d5166; }
    .btn-secondary { background: #f5f5f5; color: #2d2d2d; border: 1px solid #ddd; }
    .btn-secondary:hover { background: #eee; }
    .btn-danger { background: #fff; color: #c44; border: 1px solid #ddd; }
    .btn-small { padding: 6px 12px; font-size: 12px; }
    input, textarea, select { padding: 10px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; font-family: inherit; }
    input:focus, textarea:focus, select:focus { outline: none; border-color: #999; }
    label { font-size: 14px; color: #666; display: block; margin-bottom: 6px; }
    .form-group { margin-bottom: 16px; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .card { background: #fff; border: 1px solid #e8e6e3; border-radius: 8px; padding: 20px; margin-bottom: 12px; }
    .book-card { display: flex; gap: 16px; }
    .book-cover { width: 65px; height: 100px; background: #eee; border-radius: 4px; flex-shrink: 0; overflow: hidden; }
    .book-cover img { width: 100%; height: 100%; object-fit: cover; }
    .book-info { flex: 1; min-width: 0; }
    .book-title { font-family: 'Libre Baskerville', serif; font-size: 1rem; margin-bottom: 4px; }
    .book-title a:hover { text-decoration: underline; }
    .book-author { color: #666; font-size: 0.85rem; margin-bottom: 8px; }
    .book-review { font-size: 0.85rem; color: #555; margin-top: 8px; }
    .book-actions { display: flex; gap: 8px; align-items: flex-start; }
    .rating-circle { width: 44px; height: 44px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: 700; color: #fff; flex-shrink: 0; }
    .rating-unrated { background: #ccc; font-size: 11px; }
    .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; padding-top: 16px; flex-wrap: wrap; gap: 12px; }
    .back-link { background: none; border: none; cursor: pointer; color: #666; font-size: 14px; padding: 0; font-family: inherit; }
    .back-link:hover { color: #2d2d2d; }
    .empty-state { text-align: center; padding: 60px 20px; color: #888; }
    .loading { text-align: center; padding: 40px; color: #888; }
    .error { color: #c44; font-size: 13px; margin-top: 8px; }
    .stats { display: grid; grid-template-columns: repeat(4, 1fr); text-align: center; gap: 16px; margin-bottom: 24px; }
    .stat-number { font-family: 'Libre Baskerville', serif; font-size: 1.75rem; color: #2d2d2d; }
    .stat-label { font-size: 0.7rem; color: #888; text-transform: uppercase; letter-spacing: 0.05em; }
    .section-title { font-size: 1rem; font-weight: 500; margin-bottom: 16px; padding-bottom: 8px; border-bottom: 1px solid #e8e6e3; }
    .import-section { margin-top: 24px; padding: 20px; background: #fff; border: 1px solid #e8e6e3; border-radius: 8px; }
    .import-section textarea { width: 100%; height: 150px; margin: 12px 0; }
    .book-rank { font-size: 14px; color: #999; margin-right: 12px; min-width: 30px; }
    .admin-badge { display: inline-block; background: #2D3E50; color: #fff; font-size: 11px; padding: 2px 8px; border-radius: 10px; margin-left: 8px; }
    @media (max-width: 600px) {
      .form-row { grid-template-columns: 1fr; }
      .stats { grid-template-columns: repeat(2, 1fr); }
      .book-actions { flex-direction: column; }
      nav { gap: 6px; }
      nav button { padding: 6px 12px; font-size: 13px; }
    }
  </style>
</head>
<body>
  <div id="app"><div class="loading">Loading...</div></div>
  <script>
    let books = [];
    let view = 'list';
    let yearFilter = 'all';
    let editingBook = null;
    let form = { title: '', author: '', year: '', cover: '', rating: null, review: '', dateRead: '', isbn: '', amazonLink: '', pageCount: null };
    let isbnInput = '';
    let loading = true;
    let error = '';
    let batchUpdateStatus = '';
    const AFFILIATE_TAG = 'pagesturned0f-20';
    
    // Admin authentication
    const ADMIN_KEY = 'CV!vxUCQvr*p47xNX@ZB';
    let isAdmin = false;
    
    function checkAdmin() {
      const urlParams = new URLSearchParams(window.location.search);
      const key = urlParams.get('admin');
      if (key === ADMIN_KEY) {
        isAdmin = true;
        sessionStorage.setItem('adminAuth', 'true');
      } else if (sessionStorage.getItem('adminAuth') === 'true') {
        isAdmin = true;
      }
    }
    
    function logout() {
      sessionStorage.removeItem('adminAuth');
      isAdmin = false;
      window.location.href = window.location.pathname;
    }
    
    checkAdmin();

    const logoSVG = `<svg viewBox="0 0 120 60" xmlns="http://www.w3.org/2000/svg">
      <g transform="translate(8, 6) scale(0.8)">
        <rect x="0" y="0" width="32" height="48" rx="2" fill="#f5f5f5" stroke="#2d2d2d" stroke-width="1.5"/>
        <line x1="6" y1="10" x2="26" y2="10" stroke="#ddd" stroke-width="2"/>
        <line x1="6" y1="17" x2="23" y2="17" stroke="#ddd" stroke-width="2"/>
        <line x1="6" y1="24" x2="25" y2="24" stroke="#ddd" stroke-width="2"/>
        <line x1="6" y1="31" x2="20" y2="31" stroke="#ddd" stroke-width="2"/>
        <path d="M 40 24 L 54 24" fill="none" stroke="#2D3E50" stroke-width="2" stroke-linecap="round"/>
        <path d="M 50 19 L 55 24 L 50 29" fill="none" stroke="#2D3E50" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        <rect x="62" y="0" width="32" height="48" rx="2" fill="#2D3E50"/>
        <path d="M 72 25 L 77 31 L 88 17" fill="none" stroke="#faf9f7" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
      </g>
    </svg>`;

    async function batchUpdateAmazonLinks() {
      batchUpdateStatus = 'Updating Amazon links...';
      render();
      let updated = 0;
      
      for (let book of books) {
        if (book.isbn && !book.amazonLink) {
          book.amazonLink = `https://www.amazon.com/dp/${book.isbn}?tag=${AFFILIATE_TAG}`;
          updated++;
        }
      }
      
      if (updated > 0) {
        await saveBooks();
        batchUpdateStatus = `‚úì Updated ${updated} Amazon links`;
      } else {
        batchUpdateStatus = 'No books needed Amazon link updates';
      }
      render();
      setTimeout(() => { batchUpdateStatus = ''; render(); }, 3000);
    }

    async function batchUpdateCovers() {
      batchUpdateStatus = 'Updating covers and page counts...';
      render();
      let updatedCovers = 0;
      let updatedPages = 0;
      
      for (let book of books) {
        if (book.isbn && (!book.cover || !book.pageCount)) {
          try {
            const res = await fetch(`https://www.googleapis.com/books/v1/volumes?q=isbn:${book.isbn}`);
            const data = await res.json();
            
            if (data.items && data.items.length > 0) {
              const vol = data.items[0].volumeInfo;
              
              if (!book.cover && vol.imageLinks?.thumbnail) {
                book.cover = vol.imageLinks.thumbnail.replace('http:', 'https:');
                updatedCovers++;
              } else if (!book.cover) {
                book.cover = `https://covers.openlibrary.org/b/isbn/${book.isbn}-L.jpg`;
                updatedCovers++;
              }
              
              if (!book.pageCount && vol.pageCount) {
                book.pageCount = vol.pageCount;
                updatedPages++;
              }
            }
            
            await new Promise(resolve => setTimeout(resolve, 100));
          } catch (e) {
            console.error('Failed to fetch for ISBN:', book.isbn);
          }
        }
      }
      
      if (updatedCovers > 0 || updatedPages > 0) {
        await saveBooks();
        batchUpdateStatus = `‚úì Updated ${updatedCovers} covers, ${updatedPages} page counts`;
      } else {
        batchUpdateStatus = 'No books needed updates';
      }
      render();
      setTimeout(() => { batchUpdateStatus = ''; render(); }, 3000);
    }

    const getColor = r => {
      if (r === null) return '#ccc';
      if (r >= 90) return '#2E7D32';
      if (r >= 70) return '#66BB6A';
      if (r >= 50) return '#FFC107';
      if (r >= 30) return '#FF9800';
      return '#E53935';
    };

    const getYear = d => d ? d.slice(0, 4) : 'Unknown';
    const getYearGroup = d => {
      const y = getYear(d);
      if (!y || y === 'Unknown') return 'Older';
      const n = parseInt(y);
      return n >= 2020 ? y : 'Older';
    };
    const formatReadDate = d => {
      if (!d) return '';
      const date = new Date(d);
      const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
      return `${months[date.getMonth()]} ${date.getFullYear()}`;
    };

    async function loadBooks() {
      try {
        const res = await fetch('/api/books');
        const data = await res.json();
        books = data.books || [];
      } catch (e) { books = []; }
      loading = false;
      render();
    }

    async function saveBooks() {
      try {
        await fetch('/api/books', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ books })
        });
      } catch (e) { console.error('Save failed:', e); }
      render();
    }

    async function fetchISBN() {
      if (!isbnInput.trim()) return;
      error = '';
      try {
        const googleRes = await fetch(`https://www.googleapis.com/books/v1/volumes?q=isbn:${isbnInput.trim()}`);
        const googleData = await googleRes.json();
        
        if (googleData.items && googleData.items.length > 0) {
          const book = googleData.items[0].volumeInfo;
          form.title = book.title || form.title;
          form.author = book.authors?.[0] || form.author;
          form.year = book.publishedDate?.match(/\d{4}/)?.[0] || form.year;
          form.pageCount = book.pageCount || form.pageCount;
          
          if (book.imageLinks?.thumbnail) {
            form.cover = book.imageLinks.thumbnail.replace('http:', 'https:');
          } else {
            form.cover = `https://covers.openlibrary.org/b/isbn/${isbnInput.trim()}-L.jpg`;
          }
          form.isbn = isbnInput.trim();
          form.amazonLink = `https://www.amazon.com/dp/${isbnInput.trim()}?tag=${AFFILIATE_TAG}`;
        } else {
          const res = await fetch(`https://openlibrary.org/api/books?bibkeys=ISBN:${isbnInput.trim()}&format=json&jscmd=data`);
          const data = await res.json();
          const b = data[`ISBN:${isbnInput.trim()}`];
          if (b) {
            form.title = b.title || form.title;
            form.author = b.authors?.[0]?.name || form.author;
            form.year = b.publish_date?.match(/\d{4}/)?.[0] || form.year;
            form.cover = `https://covers.openlibrary.org/b/isbn/${isbnInput.trim()}-L.jpg`;
            form.isbn = isbnInput.trim();
            form.amazonLink = `https://www.amazon.com/dp/${isbnInput.trim()}?tag=${AFFILIATE_TAG}`;
          } else {
            error = 'Book not found.';
          }
        }
      } catch (e) { error = 'Failed to fetch.'; }
      render();
    }

    function resetForm() {
      form = { title: '', author: '', year: '', cover: '', rating: null, review: '', dateRead: '', isbn: '', amazonLink: '', pageCount: null };
      isbnInput = '';
      error = '';
    }

    function openAdd() { resetForm(); editingBook = null; view = 'edit'; render(); }
    function openEdit(book) {
      form = { ...book, year: String(book.year || ''), rating: book.rating, pageCount: book.pageCount };
      isbnInput = book.isbn || '';
      editingBook = book;
      view = 'edit';
      render();
    }
    function deleteBook(id) {
      if (confirm('Delete this book?')) {
        books = books.filter(b => b.id !== id);
        saveBooks();
      }
    }
    function saveBook() {
      if (!form.title.trim()) { error = 'Title required'; render(); return; }
      const rating = form.rating === '' || form.rating === null ? null : parseInt(form.rating);
      const pageCount = form.pageCount === '' || form.pageCount === null ? null : parseInt(form.pageCount);
      if (editingBook) {
        books = books.map(b => b.id === editingBook.id ? { ...form, id: b.id, year: parseInt(form.year) || null, rating, pageCount } : b);
      } else {
        books.push({ ...form, id: Date.now(), year: parseInt(form.year) || null, rating, pageCount });
      }
      saveBooks();
      view = 'list';
      resetForm();
    }
    function goBack() { view = 'list'; resetForm(); render(); }
    function setYear(y) { yearFilter = y; render(); }
    function setView(v) { view = v; render(); }

    function importBooks(json) {
      try {
        const imported = JSON.parse(json);
        if (Array.isArray(imported)) {
          books = imported.map((b, i) => ({ ...b, id: Date.now() + i }));
          saveBooks();
          alert(`Imported ${books.length} books!`);
        }
      } catch (e) { alert('Invalid JSON'); }
    }

    function ratingCircle(r) {
      const color = getColor(r);
      const label = r === null ? '‚Äî' : r;
      const cls = r === null ? 'rating-circle rating-unrated' : 'rating-circle';
      return `<div class="${cls}" style="background:${color};box-shadow:0 3px 10px ${color}44">${label}</div>`;
    }

    function filterBooks() {
      if (yearFilter === 'all') return [...books].sort((a,b) => (b.rating||0) - (a.rating||0));
      if (yearFilter === 'rankings') return [...books].filter(b => b.rating !== null).sort((a,b) => b.rating - a.rating);
      return books.filter(b => getYearGroup(b.dateRead) === yearFilter).sort((a,b) => (b.rating||0) - (a.rating||0));
    }

    function renderList() {
      if (loading) return '<div class="loading">Loading...</div>';
      const years = ['all', '2025', '2024', '2023', '2022', '2021', '2020', 'Older', 'rankings'];
      const filtered = filterBooks();
      const rated = books.filter(b => b.rating !== null);
      const avg = rated.length ? (rated.reduce((s,b) => s + b.rating, 0) / rated.length).toFixed(0) : '‚Äî';

      const totalPages = books.reduce((sum, b) => sum + (b.pageCount || 0), 0);

      let html = `
        <header>
          <div class="logo">${logoSVG}</div>
          <h1>Pages Turned${isAdmin ? '<span class="admin-badge">Admin</span>' : ''}</h1>
          <p class="subtitle">${books.length} books</p>
          <nav>
            ${years.map(y => `<button class="${yearFilter === y ? 'active' : ''}" onclick="setYear('${y}')">${y === 'all' ? 'All' : y === 'rankings' ? 'üèÜ Rankings' : y}</button>`).join('')}
          </nav>
        </header>
        <div class="container">
          <div class="top-bar">
            <div>${isAdmin ? `<button class="btn btn-secondary btn-small" onclick="logout()">Logout</button>` : ''}</div>
            <div style="display:flex;gap:8px;">
              ${isAdmin ? `<button class="btn btn-secondary" onclick="setView('import')">Utilities</button>
              <button class="btn" onclick="openAdd()">+ Add Book</button>` : ''}
            </div>
          </div>
          <div class="card stats">
            <div><div class="stat-number">${books.length}</div><div class="stat-label">Books</div></div>
            <div><div class="stat-number">${totalPages.toLocaleString()}</div><div class="stat-label">Pages</div></div>
            <div><div class="stat-number">${avg}</div><div class="stat-label">Avg Rating</div></div>
            <div><div class="stat-number">${books.filter(b => b.rating >= 90).length}</div><div class="stat-label">90+ Books</div></div>
          </div>`;

      if (yearFilter === 'rankings') {
        html += `<h2 class="section-title">All-Time Rankings</h2>`;
        filtered.forEach((book, i) => {
          html += `<div class="card book-card">
            <div class="book-rank">#${i + 1}</div>
            <div class="book-cover">${book.cover ? `<img src="${book.cover}" onerror="this.parentElement.innerHTML=''">`  : ''}</div>
            <div class="book-info">
              <div class="book-title">${book.amazonLink ? `<a href="${book.amazonLink}" target="_blank" rel="noopener noreferrer" style="color:#2d2d2d;text-decoration:none">${book.title}</a>` : book.title}</div>
              <p class="book-author">${book.author || ''}${book.year ? ` (${book.year})` : ''}${book.dateRead ? ` ‚Ä¢ Read ${formatReadDate(book.dateRead)}` : ''}${book.pageCount ? ` ‚Ä¢ ${book.pageCount} pages` : ''}</p>
            </div>
            ${ratingCircle(book.rating)}
          </div>`;
        });
      } else {
        if (filtered.length === 0) {
          html += '<div class="empty-state">No books found.</div>';
        } else {
          filtered.forEach(book => {
            html += `<div class="card book-card">
              <div class="book-cover">${book.cover ? `<img src="${book.cover}" onerror="this.parentElement.innerHTML=''">`  : ''}</div>
              <div class="book-info">
                <div class="book-title">${book.amazonLink ? `<a href="${book.amazonLink}" target="_blank" rel="noopener noreferrer" style="color:#2d2d2d;text-decoration:none">${book.title}</a>` : book.title}</div>
                <p class="book-author">${book.author || ''}${book.year ? ` (${book.year})` : ''}${book.dateRead ? ` ‚Ä¢ Read ${formatReadDate(book.dateRead)}` : ''}${book.pageCount ? ` ‚Ä¢ ${book.pageCount} pages` : ''}</p>
                ${book.review ? `<p class="book-review">${book.review}</p>` : ''}
              </div>
              ${ratingCircle(book.rating)}
              ${isAdmin ? `<div class="book-actions">
                <button class="btn btn-secondary btn-small" onclick="openEdit(books.find(b=>b.id===${book.id}))">Edit</button>
                <button class="btn btn-danger btn-small" onclick="deleteBook(${book.id})">Delete</button>
              </div>` : ''}
            </div>`;
          });
        }
      }
      html += '</div>';
      return html;
    }

    function renderEdit() {
      if (!isAdmin) { view = 'list'; render(); return ''; }
      return `
        <div class="container" style="padding-top:32px">
          <button class="back-link" onclick="goBack()">‚Üê Back</button>
          <h1 style="font-family:'Libre Baskerville',serif;font-size:1.4rem;font-weight:400;margin:20px 0">${editingBook ? 'Edit Book' : 'Add Book'}</h1>
          <div class="card">
            <div class="form-group">
              <label>Import from ISBN</label>
              <div style="display:flex;gap:8px">
                <input type="text" value="${isbnInput}" oninput="isbnInput=this.value" placeholder="e.g. 9780593321201" style="flex:1">
                <button class="btn" onclick="fetchISBN()">Fetch</button>
              </div>
              ${error ? `<p class="error">${error}</p>` : ''}
            </div>
            <hr style="border:none;border-top:1px solid #eee;margin:20px 0">
            ${form.cover ? `<div style="text-align:center;margin-bottom:16px"><img src="${form.cover}" style="height:120px;border-radius:4px" onerror="this.style.display='none'"></div>` : ''}
            <div class="form-group">
              <label>Title *</label>
              <input type="text" value="${form.title}" oninput="form.title=this.value" style="width:100%">
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>Author</label>
                <input type="text" value="${form.author}" oninput="form.author=this.value" style="width:100%">
              </div>
              <div class="form-group">
                <label>Year Published</label>
                <input type="text" value="${form.year}" oninput="form.year=this.value" style="width:100%">
              </div>
            </div>
            <div class="form-group">
              <label>Cover URL</label>
              <input type="text" value="${form.cover}" oninput="form.cover=this.value" placeholder="https://..." style="width:100%">
            </div>
            <div class="form-group">
              <label>Amazon Link</label>
              <input type="text" value="${form.amazonLink || ''}" oninput="form.amazonLink=this.value" placeholder="https://www.amazon.com/dp/..." style="width:100%">
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>Date Read</label>
                <input type="date" value="${form.dateRead}" oninput="form.dateRead=this.value">
              </div>
              <div class="form-group">
                <label>Page Count</label>
                <input type="number" min="1" value="${form.pageCount || ''}" oninput="form.pageCount=this.value" placeholder="Optional">
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>Rating (1-100)</label>
                <input type="number" min="1" max="100" value="${form.rating || ''}" oninput="form.rating=this.value" placeholder="Leave blank if unrated">
              </div>
              <div class="form-group">
              </div>
            </div>
            <div class="form-group">
              <label>Review</label>
              <textarea oninput="form.review=this.value" rows="4" style="width:100%">${form.review}</textarea>
            </div>
            <button class="btn" onclick="saveBook()" style="width:100%">${editingBook ? 'Save Changes' : 'Add Book'}</button>
          </div>
        </div>`;
    }

    function renderImport() {
      if (!isAdmin) { view = 'list'; render(); return ''; }
      return `
        <div class="container" style="padding-top:32px">
          <button class="back-link" onclick="setView('list')">‚Üê Back</button>
          <h1 style="font-family:'Libre Baskerville',serif;font-size:1.4rem;font-weight:400;margin:20px 0">Import & Utilities</h1>
          
          <div class="card">
            <h3 style="font-size:1rem;margin-bottom:12px">Batch Updates</h3>
            <p style="margin-bottom:12px;color:#666;font-size:14px">Automatically update all books with missing data</p>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <button class="btn btn-secondary" onclick="batchUpdateAmazonLinks()">Update Amazon Links</button>
              <button class="btn btn-secondary" onclick="batchUpdateCovers()">Update Covers & Pages</button>
            </div>
            ${batchUpdateStatus ? `<p style="margin-top:12px;color:#2E7D32;font-size:14px">${batchUpdateStatus}</p>` : ''}
          </div>

          <div class="card" style="margin-top:16px">
            <h3 style="font-size:1rem;margin-bottom:12px">Import Books</h3>
            <p style="margin-bottom:12px;color:#666;font-size:14px">Paste your books JSON array below. This will replace all existing books.</p>
            <textarea id="importData" placeholder='[{"title":"Book Title","author":"Author Name",...}]' style="width:100%;height:200px;font-family:monospace;font-size:12px"></textarea>
            <button class="btn" onclick="importBooks(document.getElementById('importData').value)" style="margin-top:12px">Import</button>
          </div>
        </div>`;
    }

    function render() {
      const app = document.getElementById('app');
      if (view === 'edit') app.innerHTML = renderEdit();
      else if (view === 'import') app.innerHTML = renderImport();
      else app.innerHTML = renderList();
    }

    loadBooks();
  </script>
</body>
</html>
