<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pages Turned</title>
  <!-- V2.0.0 - New rating colors, clickable covers, mobile header size, alignment fixes, tooltip format -->
  
  <!-- Favicon -->
  <link rel="icon" type="image/png" sizes="32x32" href="favicon-32.png">
  <link rel="icon" type="image/png" href="favicon.png">
  <link rel="apple-touch-icon" href="apple-touch-icon.png">
  
  <!-- Open Graph / Social Media Meta Tags -->
  <meta property="og:title" content="Pages Turned">
  <meta property="og:description" content="The TL;DR of book reviews">
  <meta property="og:image" content="icon.png">
  <meta property="og:type" content="website">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Pages Turned">
  <meta name="twitter:description" content="The TL;DR of book reviews">
  <meta name="twitter:image" content="icon.png">
  
  <!-- General Meta -->
  <meta name="description" content="The TL;DR of book reviews. One-sentence reviews with a 1-100 rating system.">
  <meta name="theme-color" content="#2D3E50">
  
  <link href="https://fonts.googleapis.com/css2?family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&family=Inter:wght@400;500;600&family=Architects+Daughter&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Inter', system-ui, sans-serif; background: #faf9f7; color: #2D3E50; line-height: 1.6; }
    .container { max-width: 900px; margin: 0 auto; padding: 8px 24px 24px 24px; }
    
    /* New Header Layout - V1.7.1 */
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      max-width: 900px;
      margin: 0 auto;
      padding: 24px 24px;
      gap: 24px;
    }
    .header-border {
      border-bottom: 1px solid #e8e6e3;
    }
    .logo-section {
      display: flex;
      align-items: center;
      gap: 20px;
    }
    .logo-icon {
      height: 90px;
      width: auto;
    }
    .brand-text {
      display: flex;
      flex-direction: column;
      line-height: 1.2;
    }
    .brand-name {
      font-family: 'Libre Baskerville', serif;
      font-size: 1.8rem;
      font-weight: 700;
      color: #2D3E50;
      margin-bottom: 8px;
    }
    .tagline {
      color: #555;
      font-size: 1.0rem;
    }
    
    nav { display: flex; flex-wrap: wrap; gap: 8px; justify-content: flex-end; }
    nav button { background: none; border: 1px solid #ddd; padding: 8px 16px; border-radius: 20px; cursor: pointer; font-size: 14px; font-family: inherit; transition: all 0.2s; }
    nav button:hover { border-color: #999; }
    nav button.active { background: #2D3E50; color: #fff; border-color: #2D3E50; font-weight: 500; }
    .mobile-nav { display: none !important; position: relative; }
    .btn { padding: 10px 20px; background: #2D3E50; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-family: inherit; }
    .btn:hover { background: #3d4e60; }
    .btn-secondary { background: #f5f5f5; color: #2D3E50; border: 1px solid #ddd; }
    .btn-secondary:hover { background: #eee; }
    .btn-danger { background: #fff; color: #c44; border: 1px solid #ddd; }
    .btn-small { padding: 6px 12px; font-size: 12px; }
    input, textarea, select { padding: 10px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; font-family: inherit; }
    input:focus, textarea:focus, select:focus { outline: none; border-color: #999; }
    label { font-size: 14px; color: #666; display: block; margin-bottom: 6px; }
    .form-group { margin-bottom: 16px; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .card { background: #fff; border: 1px solid #e8e6e3; border-radius: 8px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.12); }
    .card:hover { transform: translateY(-4px); box-shadow: 0 8px 24px rgba(45, 62, 80, 0.15); transition: all 0.3s ease; }
    .book-card { display: flex; gap: 16px; align-items: flex-start; }
    .book-cover { width: 65px; height: 100px; background: #eee; border-radius: 4px; flex-shrink: 0; overflow: hidden; margin: 0 4px; }
    .book-cover a { display: block; width: 100%; height: 100%; }
    .book-cover img { width: 100%; height: 100%; object-fit: cover; }
    .book-info { flex: 1; min-width: 0; }
    .book-title { font-family: 'Libre Baskerville', serif; font-size: 1.15rem; font-weight: 700; color: #2D3E50; margin-bottom: 6px; margin-top: 0; }
    .book-title-link { color: #2D3E50; text-decoration: none; }
    .book-title-link:hover { text-decoration: underline; }
    .book-author { color: #888; font-size: 0.85rem; margin-bottom: 4px; }
    .book-date-read { color: #999; font-size: 0.85rem; margin-bottom: 8px; }
    
    /* V1.9.7 Review Styling - Navy quotation mark accent */
    .book-review {
      font-family: 'Libre Baskerville', serif;
      font-size: 1.05rem;
      color: #2D3E50;
      line-height: 1.5;
      margin-top: 12px;
      position: relative;
      padding-left: 24px;
    }
    .book-review::before {
      content: '"';
      position: absolute;
      left: 0;
      top: -4px;
      font-size: 2.5rem;
      color: #2D3E50;
      font-family: Georgia, serif;
      line-height: 1;
      opacity: 0.5;
    }
    
    .book-actions { display: flex; gap: 8px; align-items: flex-start; }
    .rating-circle { width: 44px; height: 44px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: 700; color: #fff; flex-shrink: 0; position: relative; cursor: help; }
    .rating-circle:hover::after { content: '1-100 scale'; position: absolute; bottom: -32px; left: 50%; transform: translateX(-50%); background: #2D3E50; color: white; padding: 4px 12px; border-radius: 4px; font-size: 12px; white-space: nowrap; z-index: 100; }
    .rating-unrated { background: #ccc; font-size: 11px; }
    .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding-top: 0; flex-wrap: wrap; gap: 12px; }
    .back-link { background: none; border: none; cursor: pointer; color: #666; font-size: 14px; padding: 0; font-family: inherit; }
    .back-link:hover { color: #2D3E50; }
    .empty-state { text-align: center; padding: 60px 20px; color: #888; }
    .loading { text-align: center; padding: 40px; color: #888; }
    .error { color: #c44; font-size: 13px; margin-top: 8px; }
    .stats { display: grid; grid-template-columns: repeat(4, 1fr); text-align: center; gap: 16px; margin-bottom: 24px; box-shadow: 0 4px 12px rgba(0,0,0,0.12); }
    .stat-with-tooltip { position: relative; cursor: help; }
    .stat-with-tooltip:hover::after { content: '1-100 scale'; position: absolute; bottom: -24px; left: 50%; transform: translateX(-50%); background: #2D3E50; color: white; padding: 4px 12px; border-radius: 4px; font-size: 12px; white-space: nowrap; z-index: 10; }
    .stat-number { font-family: 'Libre Baskerville', serif; font-size: 1.75rem; color: #2D3E50; }
    .stat-label { font-size: 0.7rem; color: #888; text-transform: uppercase; letter-spacing: 0.05em; }
    .section-title { font-family: 'Libre Baskerville', serif; font-size: 1.35rem; font-weight: 500; margin-bottom: 16px; padding-bottom: 8px; border-bottom: 1px solid #e8e6e3; color: #2D3E50; }
    .book-rank { 
      width: 56px; 
      flex-shrink: 0; 
      text-align: center; 
      line-height: 1;
      display: flex;
      align-items: flex-start;
      justify-content: center;
      font-family: 'Architects Daughter', cursive;
      font-size: 1.8rem;
      color: #888;
    }
    .book-rank .hash {
      color: #bbb;
    }
    .book-rank .num {
      color: #888;
    }
    .format-selector { display: flex; gap: 8px; }
    .format-btn { padding: 8px 16px; border: 2px solid #ddd; background: #fff; border-radius: 6px; cursor: pointer; font-size: 14px; transition: all 0.2s; }
    .format-btn:hover { border-color: #999; }
    .format-btn.selected { border-color: #2D3E50; background: #f0f4f8; }
    footer { text-align: center; padding: 40px 24px; border-top: 1px solid #e8e6e3; margin-top: 40px; color: #888; font-size: 0.9rem; line-height: 1.6; }
    .rating-legend { display: flex; flex-direction: row; flex-wrap: wrap; justify-content: center; align-items: center; gap: 16px; margin-top: 12px; }
    .rating-legend-item { display: flex; align-items: center; gap: 8px; font-size: 0.85rem; }
    .legend-circle { width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 700; color: #fff; flex-shrink: 0; }
    
    /* Dropdown menu for Older years */
    .dropdown { position: relative; display: inline-block; }
    .dropdown-content { display: none; position: absolute; background: white; min-width: 120px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); border-radius: 8px; z-index: 1000; top: 100%; margin-top: 8px; border: 1px solid #e8e6e3; }
    .dropdown-content button { display: block; width: 100%; text-align: left; padding: 10px 16px; border: none; background: none; cursor: pointer; font-size: 14px; font-family: inherit; transition: background 0.2s; border-radius: 0; }
    .dropdown-content button:first-child { border-radius: 8px 8px 0 0; }
    .dropdown-content button:last-child { border-radius: 0 0 8px 8px; }
    .dropdown-content button:hover { background: #f5f5f5; }
    .dropdown.active .dropdown-content { display: block; }
    
    /* Last Update tooltip */
    .stat-last-update { position: relative; cursor: help; }
    
    @media (max-width: 600px) {
      /* Mobile header layout - Option 3: icon on top, text stacked below, dropdown nav */
      header {
        flex-direction: column;
        align-items: center;
        padding: 24px 20px;
        gap: 0;
      }
      .logo-section {
        flex-direction: column;
        align-items: center;
        gap: 4px;
      }
      .logo-icon {
        height: 120px;
      }
      .brand-text {
        text-align: center;
      }
      .brand-name {
        font-size: 2.5rem;
        margin-bottom: 4px;
      }
      .tagline {
        font-size: 1.25rem;
      }
      
      /* Hide regular nav on mobile, show mobile dropdown */
      nav.desktop-nav {
        display: none;
      }
      .mobile-nav {
        display: flex !important;
        margin-top: 20px;
      }
      .mobile-nav-btn {
        background: #2D3E50;
        color: #fff;
        border: none;
        padding: 10px 20px;
        border-radius: 20px;
        cursor: pointer;
        font-size: 14px;
        font-family: inherit;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 6px;
      }
      .mobile-nav-btn::after {
        content: 'â–¼';
        font-size: 10px;
      }
      .mobile-nav .dropdown-content {
        left: 50%;
        transform: translateX(-50%);
        min-width: 160px;
      }
      
      /* Mobile spacing between sections */
      .top-bar { margin-bottom: 20px; }
      .stats { margin-bottom: 32px; }
      .section-title { margin-top: 8px; }
      
      .form-row { grid-template-columns: 1fr; }
      .stats { grid-template-columns: repeat(2, 1fr); }
      .book-actions { flex-direction: column; }
      .book-review { font-size: 1rem; }
      
      /* Mobile book card layout - rank centered at top of card */
      .book-card { 
        flex-wrap: wrap; 
        position: relative; 
        padding-top: 56px;
      }
      .book-card .book-rank { 
        position: absolute; 
        top: 16px; 
        left: 0;
        right: 0;
        width: 100%;
        text-align: center;
        margin-right: 0;
        font-size: 2.0rem;
      }
      .book-card .book-cover { 
        width: 55px; 
        height: 85px; 
        margin-top: 0;
      }
      .book-card .book-info { 
        min-width: calc(100% - 130px);
        margin-top: 0;
      }
      .book-card .rating-circle { 
        margin: 12px auto 0; 
      }
      .book-card .rating-circle { margin: 12px auto 0; }
      .rating-legend { flex-direction: column; }
    }
  </style>
</head>
<body>
  <div id="app"><div class="loading">Loading...</div></div>
  <script>
    // V1.7.1 - Pages Turned with constrained header width
    let books = [];
    let view = 'list';
    let yearFilter = 'all-time';
    let editingBook = null;
    let form = { title: '', author: '', year: '', cover: '', rating: null, review: '', dateRead: '', isbn: '', pageCount: null, format: 'physical' };
    let isbnInput = '';
    let loading = true;
    let error = '';
    let isAdmin = false;
    let dropdownOpen = false;

    // Emoji constants (unicode escapes to avoid encoding issues)
    const EMOJI = {
      trophy: '\u{1F3C6}',
      book: '\u{1F4D6}',
      phone: '\u{1F4F1}',
      headphones: '\u{1F3A7}',
      floppy: '\u{1F4BE}',
      dash: '\u{2014}',
      leftArrow: 'â†'
    };

    // Check for admin mode via URL parameter with password
    const urlParams = new URLSearchParams(window.location.search);
    const adminPassword = 'CV!vxUCQvr*p47xNX@ZB';
    if (urlParams.get('admin') === adminPassword) {
      isAdmin = true;
    }

    const getColor = r => {
      if (r === null) return '#ccc';
      // Greens: 70-100 (lighter = lower, darker = higher)
      if (r >= 95) return '#1B5E20';  // darkest green
      if (r >= 90) return '#2E7D32';
      if (r >= 85) return '#388E3C';
      if (r >= 80) return '#43A047';
      if (r >= 75) return '#66BB6A';
      if (r >= 70) return '#81C784';  // lightest green
      // Yellows: 60-69 (lighter = higher, darker = lower)
      if (r >= 68) return '#FFF176';  // lightest yellow
      if (r >= 66) return '#FFEE58';
      if (r >= 64) return '#FFEB3B';
      if (r >= 62) return '#FDD835';
      if (r >= 60) return '#FBC02D';  // darkest yellow
      // Oranges: 50-59 (lighter = higher, darker = lower)
      if (r >= 58) return '#FFCC80';  // lightest orange
      if (r >= 56) return '#FFB74D';
      if (r >= 54) return '#FFA726';
      if (r >= 52) return '#FF9800';
      if (r >= 50) return '#F57C00';  // darkest orange
      // Reds: 0-49 (lighter = higher, darker = lower)
      if (r >= 40) return '#EF9A9A';  // lightest red
      if (r >= 30) return '#E57373';
      if (r >= 20) return '#EF5350';
      if (r >= 10) return '#F44336';
      return '#C62828';  // darkest red
    };

    const getYear = d => d ? d.slice(0, 4) : 'Unknown';
    const getYearGroup = d => {
      const y = getYear(d);
      if (!y || y === 'Unknown') return 'Older';
      const n = parseInt(y);
      return n >= 2020 ? y : 'Older';
    };

    const getFormatEmoji = f => {
      if (f === 'ebook') return EMOJI.phone;
      if (f === 'audiobook') return EMOJI.headphones;
      return EMOJI.book;
    };

    const formatDateRead = d => {
      if (!d) return '';
      const date = new Date(d);
      const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
      const month = months[date.getMonth()];
      const year = date.getFullYear();
      return `Read ${month} ${year}`;
    };

    async function loadBooks() {
      try {
        const res = await fetch('/api/books');
        const data = await res.json();
        books = data.books || [];
      } catch (e) { books = []; }
      loading = false;
      render();
    }

    async function saveBooks() {
      try {
        await fetch('/api/books', {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${adminPassword}`
          },
          body: JSON.stringify({ books })
        });
      } catch (e) { console.error('Save failed:', e); }
      render();
    }

    async function fetchISBN() {
      if (!isbnInput.trim()) return;
      error = '';
      try {
        const res = await fetch(`https://openlibrary.org/api/books?bibkeys=ISBN:${isbnInput.trim()}&format=json&jscmd=data`);
        const data = await res.json();
        const b = data[`ISBN:${isbnInput.trim()}`];
        if (b) {
          form.title = b.title || form.title;
          form.author = b.authors?.[0]?.name || form.author;
          form.year = b.publish_date?.match(/\d{4}/)?.[0] || form.year;
          form.cover = `https://covers.openlibrary.org/b/isbn/${isbnInput.trim()}-M.jpg`;
          form.isbn = isbnInput.trim();
          form.pageCount = b.number_of_pages || form.pageCount;
          // Generate Amazon affiliate URL from ISBN
          form.amazonUrl = `https://www.amazon.com/dp/${isbnInput.trim()}?tag=pagesturned-20`;
        } else { error = 'Book not found.'; }
      } catch (e) { error = 'Failed to fetch.'; }
      render();
    }

    function resetForm() {
      form = { title: '', author: '', year: '', cover: '', rating: null, review: '', dateRead: '', isbn: '', pageCount: null, format: 'physical', amazonUrl: '' };
      isbnInput = '';
      error = '';
    }

    function openAdd() { 
      resetForm(); 
      // Default date read to today
      form.dateRead = new Date().toISOString().split('T')[0];
      editingBook = null; 
      view = 'edit'; 
      render(); 
    }
    function openEdit(book) {
      form = { ...book, year: String(book.year || ''), rating: book.rating, pageCount: book.pageCount || null, format: book.format || 'physical', amazonUrl: book.amazonUrl || '' };
      isbnInput = book.isbn || '';
      editingBook = book;
      view = 'edit';
      render();
    }
    function deleteBook(id) {
      if (confirm('Delete this book?')) {
        books = books.filter(b => b.id !== id);
        saveBooks();
      }
    }
    function saveBook() {
      // Read values from form inputs by ID
      const titleEl = document.getElementById('input-title');
      const authorEl = document.getElementById('input-author');
      const yearEl = document.getElementById('input-year');
      const coverEl = document.getElementById('input-cover');
      const amazonUrlEl = document.getElementById('input-amazonUrl');
      const dateReadEl = document.getElementById('input-dateRead');
      const pageCountEl = document.getElementById('input-pageCount');
      const ratingEl = document.getElementById('input-rating');
      const reviewEl = document.getElementById('input-review');
      
      const title = titleEl ? titleEl.value.trim() : '';
      if (!title) { error = 'Title required'; render(); return; }
      
      const author = authorEl ? authorEl.value.trim() : '';
      const year = yearEl && yearEl.value.trim() ? parseInt(yearEl.value) || null : null;
      const cover = coverEl ? coverEl.value.trim() : '';
      const amazonUrl = amazonUrlEl ? amazonUrlEl.value.trim() : '';
      const dateRead = dateReadEl ? dateReadEl.value : '';
      const pageCount = pageCountEl && pageCountEl.value.trim() !== '' ? parseInt(pageCountEl.value) : null;
      const rating = ratingEl && ratingEl.value.trim() !== '' ? parseInt(ratingEl.value) : null;
      const review = reviewEl ? reviewEl.value.trim() : '';
      
      const bookData = {
        title,
        author,
        year,
        cover,
        amazonUrl,
        dateRead,
        pageCount,
        rating,
        review,
        format: form.format,
        isbn: form.isbn || ''
      };
      
      if (editingBook) {
        books = books.map(b => b.id === editingBook.id ? { ...b, ...bookData } : b);
      } else {
        books.push({ ...bookData, id: Date.now() });
      }
      
      saveBooks();
      view = 'list';
      resetForm();
    }
    function goBack() { view = 'list'; resetForm(); render(); }
    function setYear(y) { yearFilter = y; dropdownOpen = false; render(); }
    function toggleDropdown() { dropdownOpen = !dropdownOpen; render(); }
    function setFormat(f) {
      // Update format without re-rendering to preserve form data
      form.format = f;
      // Update button styling directly
      document.querySelectorAll('.format-btn').forEach(btn => {
        btn.classList.remove('selected');
      });
      event.target.classList.add('selected');
    }
    
    function exportData() {
      const dataStr = JSON.stringify(books, null, 2);
      const dataBlob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(dataBlob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `pages-turned-backup-${new Date().toISOString().split('T')[0]}.json`;
      link.click();
      URL.revokeObjectURL(url);
    }

    function ratingCircle(r) {
      const color = getColor(r);
      const label = r === null ? EMOJI.dash : r;
      const cls = r === null ? 'rating-circle rating-unrated' : 'rating-circle';
      return `<div class="${cls}" style="background:${color};box-shadow:0 3px 10px ${color}44">${label}</div>`;
    }

    // V1.2 - Simple review rendering
    function renderReview(review) {
      if (!review) return '';
      return `<p class="book-review">${review}</p>`;
    }

    function filterBooks() {
      const currentYear = new Date().getFullYear();
      let filtered;
      
      if (yearFilter === 'all-time') {
        filtered = [...books];
      } else if (yearFilter === 'current') {
        filtered = books.filter(b => getYearGroup(b.dateRead) === String(currentYear));
      } else {
        filtered = books.filter(b => getYearGroup(b.dateRead) === yearFilter);
      }
      
      // Sort: rated books by rating (high to low), then unrated books alphabetically by title
      return filtered.sort((a, b) => {
        if (a.rating === null && b.rating === null) {
          return (a.title || '').localeCompare(b.title || '');
        }
        if (a.rating === null) return 1;
        if (b.rating === null) return -1;
        return b.rating - a.rating;
      });
    }
    
    function getMostRecentBook() {
      if (books.length === 0) return null;
      return books.reduce((latest, book) => {
        if (!book.dateRead) return latest;
        if (!latest || !latest.dateRead) return book;
        return new Date(book.dateRead) > new Date(latest.dateRead) ? book : latest;
      }, null);
    }
    
    function getYearLabel() {
      const currentYear = new Date().getFullYear();
      if (yearFilter === 'all-time') return 'All-Time Rankings';
      if (yearFilter === 'current') return `${currentYear} Rankings`;
      return `${yearFilter} Rankings`;
    }

    function renderList() {
      if (loading) return '<div class="loading">Loading...</div>';
      const currentYear = new Date().getFullYear();
      const filtered = filterBooks();
      const mostRecent = getMostRecentBook();
      
      // Calculate stats based on filtered books for current view
      const rated = filtered.filter(b => b.rating !== null);
      const avg = rated.length ? (rated.reduce((s,b) => s + b.rating, 0) / rated.length).toFixed(0) : EMOJI.dash;
      const totalPages = filtered.reduce((sum, b) => sum + (b.pageCount || 0), 0);
      
      // Get available older years (excluding current year and one previous year shown in nav)
      const allYears = [...new Set(books.map(b => getYearGroup(b.dateRead)).filter(y => y !== 'Older' && y !== 'Unknown'))];
      const olderYears = allYears.filter(y => {
        const yearNum = parseInt(y);
        return yearNum < currentYear - 1;
      }).sort((a, b) => b - a);
      
      // Check if current yearFilter is an older year (for dynamic button label)
      const isOlderYearSelected = olderYears.includes(yearFilter);

      // Get mobile nav label based on current filter
      const getMobileNavLabel = () => {
        if (yearFilter === 'all-time') return `${EMOJI.trophy} All Time`;
        if (yearFilter === 'current') return `${currentYear}`;
        return yearFilter;
      };

      let html = `
        <div class="header-border">
        <header>
          <div class="logo-section">
            <img src="icon.png" alt="Pages Turned" class="logo-icon">
            <div class="brand-text">
              <span class="brand-name">Pages Turned</span>
              <span class="tagline">The TL;DR of book reviews</span>
            </div>
          </div>
          <nav class="desktop-nav">
            <button class="${yearFilter === 'all-time' ? 'active' : ''}" onclick="setYear('all-time')">${EMOJI.trophy} All Time</button>
            <button class="${yearFilter === 'current' ? 'active' : ''}" onclick="setYear('current')">Current Year</button>
            <button class="${yearFilter === String(currentYear - 1) ? 'active' : ''}" onclick="setYear('${currentYear - 1}')">${currentYear - 1}</button>`;
      
      // Add dropdown for older years if they exist (desktop)
      if (olderYears.length > 0) {
        const dropdownLabel = isOlderYearSelected ? yearFilter : 'Older';
        html += `
            <div class="dropdown ${dropdownOpen ? 'active' : ''}">
              <button class="${isOlderYearSelected ? 'active' : ''}" onclick="toggleDropdown()">${dropdownLabel}</button>
              <div class="dropdown-content">
                ${olderYears.map(y => `<button onclick="setYear('${y}')">${y}</button>`).join('')}
              </div>
            </div>`;
      }
      
      html += `
          </nav>
          <div class="mobile-nav dropdown ${dropdownOpen ? 'active' : ''}">
            <button class="mobile-nav-btn" onclick="toggleDropdown()">${getMobileNavLabel()}</button>
            <div class="dropdown-content">
              <button onclick="setYear('all-time')">${EMOJI.trophy} All Time</button>
              <button onclick="setYear('current')">Current Year</button>
              <button onclick="setYear('${currentYear - 1}')">${currentYear - 1}</button>
              ${olderYears.map(y => `<button onclick="setYear('${y}')">${y}</button>`).join('')}
            </div>
          </div>
        </header>
        </div>
        <div class="container">
          <div class="top-bar">
            ${isAdmin ? '<button class="btn btn-secondary btn-small" onclick="exportData()">' + EMOJI.floppy + ' Backup Data</button>' : '<div></div>'}
            ${isAdmin ? '<button class="btn" onclick="openAdd()">+ Add Book</button>' : ''}
          </div>
          <div class="card stats">
            <div><div class="stat-number">${filtered.length}</div><div class="stat-label">Books</div></div>
            <div><div class="stat-number">${totalPages.toLocaleString()}</div><div class="stat-label">Pages</div></div>
            <div class="stat-with-tooltip"><div class="stat-number">${avg}</div><div class="stat-label">Avg Rating</div></div>
            <div class="stat-last-update" ${mostRecent ? `data-book="${mostRecent.title.replace(/"/g, '&quot;')} by ${(mostRecent.author || 'Unknown').replace(/"/g, '&quot;')}"` : ''}><div class="stat-number">${mostRecent && mostRecent.dateRead ? (() => { const d = new Date(mostRecent.dateRead); return `${String(d.getMonth() + 1).padStart(2, '0')}/${String(d.getDate()).padStart(2, '0')}/${String(d.getFullYear()).slice(-2)}`; })() : EMOJI.dash}</div><div class="stat-label">Last Update</div></div>
          </div>`;

      // Add section title with year label
      html += `<h2 class="section-title">${getYearLabel()}</h2>`;
      
      if (filtered.length === 0) {
        html += '<div class="empty-state">No books found.</div>';
      } else {
        filtered.forEach((book, i) => {
          const titleHtml = book.amazonUrl 
            ? `<a href="${book.amazonUrl}" target="_blank" rel="noopener" class="book-title-link">${book.title}</a>`
            : book.title;
          const coverHtml = book.cover 
            ? (book.amazonUrl 
              ? `<a href="${book.amazonUrl}" target="_blank" rel="noopener"><img src="${book.cover}" onerror="this.parentElement.parentElement.innerHTML=''"></a>`
              : `<img src="${book.cover}" onerror="this.parentElement.innerHTML=''">`
            ) : '';
          html += `<div class="card book-card">
            <div class="book-rank"><span class="hash">#</span><span class="num">${i + 1}</span></div>
            <div class="book-cover">${coverHtml}</div>
            <div class="book-info">
              <div class="book-title">${titleHtml}</div>
              <p class="book-author">${book.author || ''}${book.year ? ` (${book.year})` : ''}</p>
              ${book.dateRead ? `<p class="book-date-read">${formatDateRead(book.dateRead)} ${getFormatEmoji(book.format || 'physical')}</p>` : ''}
              ${renderReview(book.review)}
            </div>
            ${ratingCircle(book.rating)}
            ${isAdmin ? `<div class="book-actions">
              <button class="btn btn-secondary btn-small" onclick="openEdit(books.find(b=>b.id===${book.id}))">Edit</button>
              <button class="btn btn-danger btn-small" onclick="deleteBook(${book.id})">Delete</button>
            </div>` : ''}
          </div>`;
        });
      }
      html += '</div>';
      html += `<footer>
        <div class="rating-legend">
          <div class="rating-legend-item">
            <div class="legend-circle" style="background:#1B5E20;"></div>
            <span>90-100: Pick it up now</span>
          </div>
          <div class="rating-legend-item">
            <div class="legend-circle" style="background:#43A047;"></div>
            <span>80-89: Worth your time</span>
          </div>
          <div class="rating-legend-item">
            <div class="legend-circle" style="background:#FBC02D;"></div>
            <span>70-79: May strike a chord</span>
          </div>
          <div class="rating-legend-item">
            <div class="legend-circle" style="background:#EF6C00;"></div>
            <span>60-69: If you're bored</span>
          </div>
          <div class="rating-legend-item">
            <div class="legend-circle" style="background:#B71C1C;"></div>
            <span>0-59: Run away</span>
          </div>
        </div>
      </footer>`;
      return html;
    }

    function renderEdit() {
      return `
        <div class="container" style="padding-top:32px">
          <button class="back-link" onclick="goBack()">${EMOJI.leftArrow} Back</button>
          <h1 style="font-family:'Libre Baskerville',serif;font-size:1.4rem;font-weight:400;margin:20px 0">${editingBook ? 'Edit Book' : 'Add Book'}</h1>
          <div class="card">
            ${!editingBook ? `
            <div class="form-group">
              <label>Import from ISBN</label>
              <div style="display:flex;gap:8px">
                <input type="text" value="${isbnInput}" oninput="isbnInput=this.value" placeholder="e.g. 9780593321201" style="flex:1">
                <button class="btn" onclick="fetchISBN()">Fetch</button>
              </div>
              ${error ? `<p class="error">${error}</p>` : ''}
            </div>
            <hr style="border:none;border-top:1px solid #eee;margin:20px 0">
            ` : ''}
            ${form.cover ? `<div style="text-align:center;margin-bottom:16px"><img src="${form.cover}" style="height:120px;border-radius:4px" onerror="this.style.display='none'"></div>` : ''}
            <div class="form-group">
              <label>Title *</label>
              <input type="text" id="input-title" value="${form.title}" oninput="form.title=this.value" style="width:100%">
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>Author</label>
                <input type="text" id="input-author" value="${form.author}" oninput="form.author=this.value" style="width:100%">
              </div>
              <div class="form-group">
                <label>Year Published</label>
                <input type="text" id="input-year" value="${form.year}" oninput="form.year=this.value" style="width:100%">
              </div>
            </div>
            <div class="form-group">
              <label>Cover URL</label>
              <input type="text" id="input-cover" value="${form.cover}" oninput="form.cover=this.value" placeholder="https://..." style="width:100%">
            </div>
            <div class="form-group">
              <label>Amazon URL</label>
              <input type="text" id="input-amazonUrl" value="${form.amazonUrl}" oninput="form.amazonUrl=this.value" placeholder="https://amazon.com/..." style="width:100%">
            </div>
            <div class="form-group">
              <label>Format</label>
              <div class="format-selector">
                <button class="format-btn ${form.format === 'physical' ? 'selected' : ''}" onclick="setFormat('physical')">${EMOJI.book} Physical</button>
                <button class="format-btn ${form.format === 'ebook' ? 'selected' : ''}" onclick="setFormat('ebook')">${EMOJI.phone} eBook</button>
                <button class="format-btn ${form.format === 'audiobook' ? 'selected' : ''}" onclick="setFormat('audiobook')">${EMOJI.headphones} Audiobook</button>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>Date Read</label>
                <input type="date" id="input-dateRead" value="${form.dateRead}" oninput="form.dateRead=this.value">
              </div>
              <div class="form-group">
                <label>Page Count</label>
                <input type="number" id="input-pageCount" min="1" value="${form.pageCount || ''}" oninput="form.pageCount=this.value" placeholder="Number of pages">
              </div>
            </div>
            <div class="form-group">
              <label>Rating (1-100)</label>
              <input type="number" id="input-rating" min="1" max="100" value="${form.rating || ''}" oninput="form.rating=this.value" placeholder="Leave blank if unrated">
            </div>
            <div class="form-group">
              <label>Review</label>
              <textarea id="input-review" oninput="form.review=this.value" rows="4" style="width:100%">${form.review}</textarea>
            </div>
            <button class="btn" onclick="saveBook()" style="width:100%">${editingBook ? 'Save Changes' : 'Add Book'}</button>
          </div>
        </div>`;
    }

    function render() {
      const app = document.getElementById('app');
      if (view === 'edit') app.innerHTML = renderEdit();
      else app.innerHTML = renderList();
      
      // Add tooltip for Last Update stat
      const lastUpdateEl = document.querySelector('.stat-last-update');
      if (lastUpdateEl && lastUpdateEl.dataset.book) {
        lastUpdateEl.addEventListener('mouseenter', function() {
          const tooltip = document.createElement('div');
          tooltip.className = 'last-update-tooltip';
          tooltip.textContent = this.dataset.book;
          tooltip.style.cssText = 'position:absolute;bottom:-24px;left:50%;transform:translateX(-50%);background:#2D3E50;color:white;padding:4px 12px;border-radius:4px;font-size:12px;white-space:nowrap;z-index:10;';
          this.appendChild(tooltip);
        });
        lastUpdateEl.addEventListener('mouseleave', function() {
          const tooltip = this.querySelector('.last-update-tooltip');
          if (tooltip) tooltip.remove();
        });
      }
    }

    loadBooks();
  </script>
</body>
</html>
