<!DOCTYPE html>

<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Reading Journal</title>
  <link href="https://fonts.googleapis.com/css2?family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Inter', system-ui, sans-serif; background: #faf9f7; color: #2d2d2d; line-height: 1.6; }
    .container { max-width: 800px; margin: 0 auto; padding: 24px; }
    header { padding: 48px 24px 32px; text-align: center; border-bottom: 1px solid #e8e6e3; }
    h1 { font-family: 'Libre Baskerville', serif; font-size: 2.2rem; font-weight: 400; margin-bottom: 8px; }
    .subtitle { color: #666; font-size: 0.95rem; }
    .btn { padding: 10px 20px; background: #2d2d2d; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-family: inherit; }
    .btn:hover { background: #444; }
    .btn-secondary { background: #f5f5f5; color: #2d2d2d; border: 1px solid #ddd; }
    .btn-secondary:hover { background: #eee; }
    .btn-danger { background: #fff; color: #c44; border: 1px solid #ddd; }
    .btn-danger:hover { background: #fef5f5; }
    .btn-small { padding: 6px 12px; font-size: 12px; }
    input, textarea { width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; font-family: inherit; }
    input:focus, textarea:focus { outline: none; border-color: #999; }
    label { font-size: 14px; color: #666; display: block; margin-bottom: 6px; }
    .form-group { margin-bottom: 16px; }
    .form-row { display: grid; grid-template-columns: 1fr 100px; gap: 16px; }
    .card { background: #fff; border: 1px solid #e8e6e3; border-radius: 8px; padding: 24px; margin-bottom: 16px; }
    .book-card { display: flex; gap: 16px; padding: 16px; }
    .book-cover { width: 70px; height: 105px; background: #eee; border-radius: 4px; flex-shrink: 0; overflow: hidden; display: flex; align-items: center; justify-content: center; }
    .book-cover img { width: 100%; height: 100%; object-fit: cover; }
    .book-cover-placeholder { color: #aaa; font-size: 10px; text-align: center; }
    .book-info { flex: 1; min-width: 0; }
    .book-title { font-family: 'Libre Baskerville', serif; font-size: 1.1rem; margin-bottom: 4px; }
    .book-author { color: #666; font-size: 0.9rem; margin-bottom: 6px; }
    .book-rating { color: #c9a227; font-size: 14px; letter-spacing: 1px; margin-bottom: 8px; }
    .book-review { font-size: 0.9rem; color: #555; }
    .book-actions { display: flex; flex-direction: column; gap: 8px; }
    .year-section { margin-bottom: 40px; }
    .year-title { font-size: 1.1rem; font-weight: 500; margin-bottom: 16px; padding-bottom: 8px; border-bottom: 1px solid #e8e6e3; }
    .top-bar { display: flex; justify-content: flex-end; margin-bottom: 24px; padding-top: 8px; }
    .back-link { background: none; border: none; cursor: pointer; color: #666; font-size: 14px; margin-bottom: 24px; padding: 0; font-family: inherit; }
    .back-link:hover { color: #2d2d2d; }
    .isbn-row { display: flex; gap: 8px; }
    .isbn-row input { flex: 1; }
    .divider { border: none; border-top: 1px solid #eee; margin: 24px 0; }
    .cover-preview { text-align: center; margin-bottom: 20px; }
    .cover-preview img { height: 150px; border-radius: 4px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .star-rating { display: flex; gap: 4px; }
    .star { cursor: pointer; font-size: 24px; color: #ddd; }
    .star.active { color: #c9a227; }
    .star-display { color: #c9a227; }
    .empty-state { text-align: center; padding: 60px 20px; color: #888; }
    .loading { text-align: center; padding: 40px; color: #888; }
    .error { color: #c44; font-size: 13px; margin-top: 8px; }
    .stats { display: grid; grid-template-columns: repeat(3, 1fr); text-align: center; gap: 16px; margin-bottom: 32px; }
    .stat-number { font-family: 'Libre Baskerville', serif; font-size: 2rem; color: #2d2d2d; }
    .stat-label { font-size: 0.75rem; color: #888; text-transform: uppercase; letter-spacing: 0.05em; }
    @media (max-width: 600px) {
      .form-row { grid-template-columns: 1fr; }
      .book-card { flex-direction: column; }
      .book-actions { flex-direction: row; }
      .stats { grid-template-columns: 1fr; gap: 8px; }
    }
  </style>
</head>
<body>
  <div id="app"></div>

  <script>
    let books = [];
    let currentView = 'list';
    let editingBook = null;
    let formData = { title: '', author: '', year: '', cover: '', rating: 5, review: '', dateRead: '', isbn: '' };
    let isbnInput = '';
    let loading = true;
    let saving = false;
    let error = '';

    // API functions
    async function loadBooks() {
      try {
        const res = await fetch('/api/books');
        const data = await res.json();
        books = data.books || [];
      } catch (e) {
        console.error('Failed to load books:', e);
        books = [];
      }
      loading = false;
      render();
    }

    async function saveBooks() {
      saving = true;
      render();
      try {
        await fetch('/api/books', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ books })
        });
      } catch (e) {
        console.error('Failed to save:', e);
      }
      saving = false;
      render();
    }

    async function fetchISBN() {
      if (!isbnInput.trim()) return;
      error = '';
      render();
      
      try {
        const res = await fetch(`https://openlibrary.org/api/books?bibkeys=ISBN:${isbnInput.trim()}&format=json&jscmd=data`);
        const data = await res.json();
        const bookData = data[`ISBN:${isbnInput.trim()}`];
        
        if (bookData) {
          formData.title = bookData.title || formData.title;
          formData.author = bookData.authors?.[0]?.name || formData.author;
          formData.year = bookData.publish_date?.match(/\d{4}/)?.[0] || formData.year;
          formData.cover = `https://covers.openlibrary.org/b/isbn/${isbnInput.trim()}-M.jpg`;
          formData.isbn = isbnInput.trim();
        } else {
          error = 'Book not found. Try a different ISBN.';
        }
      } catch (e) {
        error = 'Failed to fetch book data.';
      }
      render();
    }

    function resetForm() {
      formData = { title: '', author: '', year: '', cover: '', rating: 5, review: '', dateRead: '', isbn: '' };
      isbnInput = '';
      error = '';
    }

    function openAdd() {
      resetForm();
      editingBook = null;
      currentView = 'edit';
      render();
    }

    function openEdit(book) {
      formData = { ...book, year: String(book.year || '') };
      isbnInput = book.isbn || '';
      editingBook = book;
      currentView = 'edit';
      render();
    }

    function deleteBook(id) {
      if (confirm('Delete this book review?')) {
        books = books.filter(b => b.id !== id);
        saveBooks();
      }
    }

    function saveBook() {
      if (!formData.title.trim()) {
        error = 'Title is required';
        render();
        return;
      }

      if (editingBook) {
        books = books.map(b => b.id === editingBook.id ? { ...formData, id: b.id, year: parseInt(formData.year) || 0 } : b);
      } else {
        books.push({ ...formData, id: Date.now(), year: parseInt(formData.year) || 0 });
      }
      
      saveBooks();
      currentView = 'list';
      resetForm();
      render();
    }

    function goBack() {
      currentView = 'list';
      resetForm();
      render();
    }

    function setRating(n) {
      formData.rating = n;
      render();
    }

    function updateForm(field, value) {
      formData[field] = value;
    }

    function updateIsbn(value) {
      isbnInput = value;
    }

    function stars(rating, interactive = false) {
      let html = '<div class="' + (interactive ? 'star-rating' : 'star-display') + '">';
      for (let i = 1; i <= 5; i++) {
        if (interactive) {
          html += `<span class="star ${i <= rating ? 'active' : ''}" onclick="setRating(${i})">★</span>`;
        } else {
          html += `<span>${i <= rating ? '★' : '☆'}</span>`;
        }
      }
      html += '</div>';
      return html;
    }

    function renderList() {
      if (loading) {
        return '<div class="loading">Loading your books...</div>';
      }

      const grouped = {};
      books.forEach(book => {
        const year = book.dateRead?.slice(0, 4) || 'Undated';
        if (!grouped[year]) grouped[year] = [];
        grouped[year].push(book);
      });

      const years = Object.keys(grouped).sort((a, b) => b.localeCompare(a));
      const avgRating = books.length ? (books.reduce((sum, b) => sum + (b.rating || 0), 0) / books.length).toFixed(1) : '0';

      let html = `
        <header>
          <h1>Reading Journal</h1>
          <p class="subtitle">${books.length} book${books.length !== 1 ? 's' : ''} reviewed</p>
        </header>
        <div class="container">
          <div class="top-bar">
            <button class="btn" onclick="openAdd()">+ Add Book</button>
          </div>
      `;

      if (books.length > 0) {
        html += `
          <div class="card stats">
            <div>
              <div class="stat-number">${books.length}</div>
              <div class="stat-label">Books Read</div>
            </div>
            <div>
              <div class="stat-number">${avgRating}</div>
              <div class="stat-label">Avg Rating</div>
            </div>
            <div>
              <div class="stat-number">${books.filter(b => b.rating === 5).length}</div>
              <div class="stat-label">5-Star Books</div>
            </div>
          </div>
        `;

        years.forEach(year => {
          html += `<section class="year-section"><h2 class="year-title">${year}</h2>`;
          grouped[year].forEach(book => {
            html += `
              <div class="card book-card">
                <div class="book-cover">
                  ${book.cover 
                    ? `<img src="${book.cover}" alt="" onerror="this.parentElement.innerHTML='<span class=\\'book-cover-placeholder\\'>No cover</span>'">`
                    : '<span class="book-cover-placeholder">No cover</span>'}
                </div>
                <div class="book-info">
                  <h3 class="book-title">${book.title}</h3>
                  <p class="book-author">${book.author || 'Unknown author'}${book.year ? ` (${book.year})` : ''}</p>
                  <div class="book-rating">${stars(book.rating)}</div>
                  ${book.review ? `<p class="book-review">${book.review}</p>` : ''}
                </div>
                <div class="book-actions">
                  <button class="btn btn-secondary btn-small" onclick="openEdit(books.find(b => b.id === ${book.id}))">Edit</button>
                  <button class="btn btn-danger btn-small" onclick="deleteBook(${book.id})">Delete</button>
                </div>
              </div>
            `;
          });
          html += '</section>';
        });
      } else {
        html += '<div class="empty-state"><p>No books yet. Add your first review!</p></div>';
      }

      html += '</div>';
      return html;
    }

    function renderEdit() {
      return `
        <div class="container" style="padding-top: 32px;">
          <button class="back-link" onclick="goBack()">← Back to all books</button>
          <h1 style="font-family: 'Libre Baskerville', serif; font-size: 1.5rem; font-weight: 400; margin-bottom: 24px;">
            ${editingBook ? 'Edit Review' : 'Add New Book'}
          </h1>
          <div class="card">
            <div class="form-group">
              <label>Import from ISBN</label>
              <div class="isbn-row">
                <input type="text" value="${isbnInput}" oninput="updateIsbn(this.value)" placeholder="e.g. 9780593321201">
                <button class="btn" onclick="fetchISBN()">Fetch</button>
              </div>
              ${error ? `<p class="error">${error}</p>` : ''}
            </div>
            
            <hr class="divider">
            
            ${formData.cover ? `<div class="cover-preview"><img src="${formData.cover}" alt="Cover" onerror="this.style.display='none'"></div>` : ''}
            
            <div class="form-group">
              <label>Title *</label>
              <input type="text" value="${formData.title}" oninput="updateForm('title', this.value)">
            </div>
            
            <div class="form-row">
              <div class="form-group">
                <label>Author</label>
                <input type="text" value="${formData.author}" oninput="updateForm('author', this.value)">
              </div>
              <div class="form-group">
                <label>Year</label>
                <input type="text" value="${formData.year}" oninput="updateForm('year', this.value)">
              </div>
            </div>
            
            <div class="form-group">
              <label>Cover Image URL</label>
              <input type="text" value="${formData.cover}" oninput="updateForm('cover', this.value)" placeholder="https://...">
            </div>
            
            <div class="form-group">
              <label>Date Read</label>
              <input type="date" value="${formData.dateRead}" oninput="updateForm('dateRead', this.value)" style="width: auto;">
            </div>
            
            <div class="form-group">
              <label>Rating</label>
              ${stars(formData.rating, true)}
            </div>
            
            <div class="form-group">
              <label>Review</label>
              <textarea rows="5" oninput="updateForm('review', this.value)">${formData.review}</textarea>

```
        </div>
        
        <button class="btn" onclick="saveBook()" style="width: 100%;">
          ${saving ? 'Saving...' : (editingBook ? 'Save Changes' : 'Add Book')}
        </button>
      </div>
    </div>
  `;
}

function render() {
  const app = document.getElementById('app');
  app.innerHTML = currentView === 'list' ? renderList() : renderEdit();
}

// Initialize
loadBooks();
```

  </script>
</body>
</html>
