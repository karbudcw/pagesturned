<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pages Turned</title>
  <link href="https://fonts.googleapis.com/css2?family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Inter', system-ui, sans-serif; background: #faf9f7; color: #2D3E50; line-height: 1.6; }
    .container { max-width: 900px; margin: 0 auto; padding: 24px; }
    header { padding: 40px 24px 24px; text-align: center; border-bottom: 1px solid #e8e6e3; }
    h1 { font-family: 'Libre Baskerville', serif; font-size: 2rem; font-weight: 400; margin-bottom: 0; }
    .subtitle { color: #666; font-size: 0.95rem; }
    nav { display: flex; justify-content: center; flex-wrap: wrap; gap: 8px; margin-top: 20px; }
    nav button { background: none; border: 1px solid #ddd; padding: 8px 16px; border-radius: 20px; cursor: pointer; font-size: 14px; font-family: inherit; transition: all 0.2s; }
    nav button:hover { border-color: #999; }
    nav button.active { background: #2D3E50; color: #fff; border-color: #2D3E50; }
    .btn { padding: 10px 20px; background: #2D3E50; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-family: inherit; }
    .btn:hover { background: #3d4e60; }
    .btn-secondary { background: #f5f5f5; color: #2D3E50; border: 1px solid #ddd; }
    .btn-secondary:hover { background: #eee; }
    .btn-danger { background: #fff; color: #c44; border: 1px solid #ddd; }
    .btn-small { padding: 6px 12px; font-size: 12px; }
    input, textarea, select { padding: 10px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; font-family: inherit; }
    input:focus, textarea:focus, select:focus { outline: none; border-color: #999; }
    label { font-size: 14px; color: #666; display: block; margin-bottom: 6px; }
    .form-group { margin-bottom: 16px; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .card { background: #fff; border: 1px solid #e8e6e3; border-radius: 8px; padding: 20px; margin-bottom: 12px; }
    .book-card { display: flex; gap: 16px; }
    .book-cover { width: 65px; height: 100px; background: #eee; border-radius: 4px; flex-shrink: 0; overflow: hidden; }
    .book-cover img { width: 100%; height: 100%; object-fit: cover; }
    .book-info { flex: 1; min-width: 0; }
    .book-title { font-family: 'Libre Baskerville', serif; font-size: 1rem; margin-bottom: 4px; }
    .book-author { color: #666; font-size: 0.85rem; margin-bottom: 8px; }
    .book-review { font-size: 0.85rem; color: #555; margin-top: 8px; }
    .book-actions { display: flex; gap: 8px; align-items: flex-start; }
    .rating-circle { width: 44px; height: 44px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: 700; color: #fff; flex-shrink: 0; }
    .rating-unrated { background: #ccc; font-size: 11px; }
    .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; padding-top: 16px; flex-wrap: wrap; gap: 12px; }
    .back-link { background: none; border: none; cursor: pointer; color: #666; font-size: 14px; padding: 0; font-family: inherit; }
    .back-link:hover { color: #2D3E50; }
    .empty-state { text-align: center; padding: 60px 20px; color: #888; }
    .loading { text-align: center; padding: 40px; color: #888; }
    .error { color: #c44; font-size: 13px; margin-top: 8px; }
    .stats { display: grid; grid-template-columns: repeat(4, 1fr); text-align: center; gap: 16px; margin-bottom: 24px; }
    .stat-number { font-family: 'Libre Baskerville', serif; font-size: 1.75rem; color: #2D3E50; }
    .stat-label { font-size: 0.7rem; color: #888; text-transform: uppercase; letter-spacing: 0.05em; }
    .section-title { font-size: 1rem; font-weight: 500; margin-bottom: 16px; padding-bottom: 8px; border-bottom: 1px solid #e8e6e3; }
    .book-rank { font-size: 14px; color: #999; margin-right: 12px; min-width: 30px; }
    .format-selector { display: flex; gap: 8px; justify-content: center; }
    .format-btn { padding: 8px 16px; border: 2px solid #ddd; background: #fff; border-radius: 6px; cursor: pointer; font-size: 14px; transition: all 0.2s; }
    .format-btn:hover { border-color: #999; }
    .format-btn.selected { border-color: #2D3E50; background: #f0f4f8; }
    @media (max-width: 600px) {
      .form-row { grid-template-columns: 1fr; }
      .stats { grid-template-columns: repeat(2, 1fr); }
      .book-actions { flex-direction: column; }
      nav { gap: 6px; }
      nav button { padding: 6px 12px; font-size: 13px; }
    }
  </style>
</head>
<body>
  <div id="app"><div class="loading">Loading...</div></div>
  <script>
    let books = [];
    let view = 'list';
    let yearFilter = 'all';
    let editingBook = null;
    let form = { title: '', author: '', year: '', cover: '', rating: null, review: '', dateRead: '', isbn: '', pageCount: null, format: 'physical' };
    let isbnInput = '';
    let loading = true;
    let error = '';

    const getColor = r => {
      if (r === null) return '#ccc';
      if (r >= 90) return '#2E7D32';
      if (r >= 70) return '#66BB6A';
      if (r >= 50) return '#FFC107';
      if (r >= 30) return '#FF9800';
      return '#E53935';
    };

    const getYear = d => d ? d.slice(0, 4) : 'Unknown';
    const getYearGroup = d => {
      const y = getYear(d);
      if (!y || y === 'Unknown') return 'Older';
      const n = parseInt(y);
      return n >= 2020 ? y : 'Older';
    };

    const getFormatEmoji = f => {
      if (f === 'ebook') return 'üì±';
      if (f === 'audiobook') return 'üéß';
      return 'üìñ';
    };

    async function loadBooks() {
      try {
        const res = await fetch('/api/books');
        const data = await res.json();
        books = data.books || [];
      } catch (e) { books = []; }
      loading = false;
      render();
    }

    async function saveBooks() {
      try {
        await fetch('/api/books', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ books })
        });
      } catch (e) { console.error('Save failed:', e); }
      render();
    }

    async function fetchISBN() {
      if (!isbnInput.trim()) return;
      error = '';
      try {
        const res = await fetch(`https://openlibrary.org/api/books?bibkeys=ISBN:${isbnInput.trim()}&format=json&jscmd=data`);
        const data = await res.json();
        const b = data[`ISBN:${isbnInput.trim()}`];
        if (b) {
          form.title = b.title || form.title;
          form.author = b.authors?.[0]?.name || form.author;
          form.year = b.publish_date?.match(/\d{4}/)?.[0] || form.year;
          form.cover = `https://covers.openlibrary.org/b/isbn/${isbnInput.trim()}-M.jpg`;
          form.isbn = isbnInput.trim();
        } else { error = 'Book not found.'; }
      } catch (e) { error = 'Failed to fetch.'; }
      render();
    }

    function resetForm() {
      form = { title: '', author: '', year: '', cover: '', rating: null, review: '', dateRead: '', isbn: '', pageCount: null, format: 'physical' };
      isbnInput = '';
      error = '';
    }

    function openAdd() { resetForm(); editingBook = null; view = 'edit'; render(); }
    function openEdit(book) {
      form = { ...book, year: String(book.year || ''), rating: book.rating, pageCount: book.pageCount || null, format: book.format || 'physical' };
      isbnInput = book.isbn || '';
      editingBook = book;
      view = 'edit';
      render();
    }
    function deleteBook(id) {
      if (confirm('Delete this book?')) {
        books = books.filter(b => b.id !== id);
        saveBooks();
      }
    }
    function saveBook() {
      if (!form.title.trim()) { error = 'Title required'; render(); return; }
      const rating = form.rating === '' || form.rating === null ? null : parseInt(form.rating);
      const pageCount = form.pageCount === '' || form.pageCount === null ? null : parseInt(form.pageCount);
      if (editingBook) {
        books = books.map(b => b.id === editingBook.id ? { ...form, id: b.id, year: parseInt(form.year) || null, rating, pageCount } : b);
      } else {
        books.push({ ...form, id: Date.now(), year: parseInt(form.year) || null, rating, pageCount });
      }
      saveBooks();
      view = 'list';
      resetForm();
    }
    function goBack() { view = 'list'; resetForm(); render(); }
    function setYear(y) { yearFilter = y; render(); }
    function setFormat(f) { form.format = f; render(); }

    function ratingCircle(r) {
      const color = getColor(r);
      const label = r === null ? '‚Äî' : r;
      const cls = r === null ? 'rating-circle rating-unrated' : 'rating-circle';
      return `<div class="${cls}" style="background:${color};box-shadow:0 3px 10px ${color}44">${label}</div>`;
    }

    function filterBooks() {
      if (yearFilter === 'all') return [...books].sort((a,b) => (b.rating||0) - (a.rating||0));
      if (yearFilter === 'rankings') return [...books].filter(b => b.rating !== null).sort((a,b) => b.rating - a.rating);
      return books.filter(b => getYearGroup(b.dateRead) === yearFilter).sort((a,b) => (b.rating||0) - (a.rating||0));
    }

    function renderList() {
      if (loading) return '<div class="loading">Loading...</div>';
      const years = ['all', '2025', '2024', '2023', '2022', '2021', '2020', 'Older', 'rankings'];
      const filtered = filterBooks();
      const rated = books.filter(b => b.rating !== null);
      const avg = rated.length ? (rated.reduce((s,b) => s + b.rating, 0) / rated.length).toFixed(0) : '‚Äî';
      const totalPages = books.reduce((sum, b) => sum + (b.pageCount || 0), 0);

      let html = `
        <header>
          <h1>Pages Turned</h1>
          <nav>
            ${years.map(y => `<button class="${yearFilter === y ? 'active' : ''}" onclick="setYear('${y}')">${y === 'all' ? 'All' : y === 'rankings' ? 'üèÜ Rankings' : y}</button>`).join('')}
          </nav>
        </header>
        <div class="container">
          <div class="top-bar">
            <div></div>
            <button class="btn" onclick="openAdd()">+ Add Book</button>
          </div>
          <div class="card stats">
            <div><div class="stat-number">${books.length}</div><div class="stat-label">Books</div></div>
            <div><div class="stat-number">${totalPages.toLocaleString()}</div><div class="stat-label">Pages</div></div>
            <div><div class="stat-number">${avg}</div><div class="stat-label">Avg Rating</div></div>
            <div><div class="stat-number">${books.filter(b => b.rating >= 90).length}</div><div class="stat-label">90+ Books</div></div>
          </div>`;

      if (yearFilter === 'rankings') {
        html += `<h2 class="section-title">All-Time Rankings</h2>`;
        filtered.forEach((book, i) => {
          html += `<div class="card book-card">
            <div class="book-rank">#${i + 1}</div>
            <div class="book-cover">${book.cover ? `<img src="${book.cover}" onerror="this.parentElement.innerHTML=''">`  : ''}</div>
            <div class="book-info">
              <div class="book-title">${book.title}</div>
              <p class="book-author">${book.author || ''}${book.year ? ` (${book.year})` : ''} ${getFormatEmoji(book.format || 'physical')}</p>
              ${book.review ? `<p class="book-review">${book.review}</p>` : ''}
            </div>
            ${ratingCircle(book.rating)}
          </div>`;
        });
      } else {
        if (filtered.length === 0) {
          html += '<div class="empty-state">No books found.</div>';
        } else {
          filtered.forEach(book => {
            html += `<div class="card book-card">
              <div class="book-cover">${book.cover ? `<img src="${book.cover}" onerror="this.parentElement.innerHTML=''">`  : ''}</div>
              <div class="book-info">
                <div class="book-title">${book.title}</div>
                <p class="book-author">${book.author || ''}${book.year ? ` (${book.year})` : ''} ${getFormatEmoji(book.format || 'physical')}</p>
                ${book.review ? `<p class="book-review">${book.review}</p>` : ''}
              </div>
              ${ratingCircle(book.rating)}
              <div class="book-actions">
                <button class="btn btn-secondary btn-small" onclick="openEdit(books.find(b=>b.id===${book.id}))">Edit</button>
                <button class="btn btn-danger btn-small" onclick="deleteBook(${book.id})">Delete</button>
              </div>
            </div>`;
          });
        }
      }
      html += '</div>';
      return html;
    }

    function renderEdit() {
      return `
        <div class="container" style="padding-top:32px">
          <button class="back-link" onclick="goBack()">‚Üê Back</button>
          <h1 style="font-family:'Libre Baskerville',serif;font-size:1.4rem;font-weight:400;margin:20px 0">${editingBook ? 'Edit Book' : 'Add Book'}</h1>
          <div class="card">
            <div class="form-group">
              <label>Import from ISBN</label>
              <div style="display:flex;gap:8px">
                <input type="text" value="${isbnInput}" oninput="isbnInput=this.value" placeholder="e.g. 9780593321201" style="flex:1">
                <button class="btn" onclick="fetchISBN()">Fetch</button>
              </div>
              ${error ? `<p class="error">${error}</p>` : ''}
            </div>
            <hr style="border:none;border-top:1px solid #eee;margin:20px 0">
            ${form.cover ? `<div style="text-align:center;margin-bottom:16px"><img src="${form.cover}" style="height:120px;border-radius:4px" onerror="this.style.display='none'"></div>` : ''}
            <div class="form-group">
              <label>Title *</label>
              <input type="text" value="${form.title}" oninput="form.title=this.value" style="width:100%">
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>Author</label>
                <input type="text" value="${form.author}" oninput="form.author=this.value" style="width:100%">
              </div>
              <div class="form-group">
                <label>Year Published</label>
                <input type="text" value="${form.year}" oninput="form.year=this.value" style="width:100%">
              </div>
            </div>
            <div class="form-group">
              <label>Cover URL</label>
              <input type="text" value="${form.cover}" oninput="form.cover=this.value" placeholder="https://..." style="width:100%">
            </div>
            <div class="form-group">
              <label>Format</label>
              <div class="format-selector">
                <button class="format-btn ${form.format === 'physical' ? 'selected' : ''}" onclick="setFormat('physical')">üìñ Physical</button>
                <button class="format-btn ${form.format === 'ebook' ? 'selected' : ''}" onclick="setFormat('ebook')">üì± eBook</button>
                <button class="format-btn ${form.format === 'audiobook' ? 'selected' : ''}" onclick="setFormat('audiobook')">üéß Audiobook</button>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>Date Read</label>
                <input type="date" value="${form.dateRead}" oninput="form.dateRead=this.value">
              </div>
              <div class="form-group">
                <label>Page Count</label>
                <input type="number" min="1" value="${form.pageCount || ''}" oninput="form.pageCount=this.value" placeholder="Number of pages">
              </div>
            </div>
            <div class="form-group">
              <label>Rating (1-100)</label>
              <input type="number" min="1" max="100" value="${form.rating || ''}" oninput="form.rating=this.value" placeholder="Leave blank if unrated">
            </div>
            <div class="form-group">
              <label>Review</label>
              <textarea oninput="form.review=this.value" rows="4" style="width:100%">${form.review}</textarea>
            </div>
            <button class="btn" onclick="saveBook()" style="width:100%">${editingBook ? 'Save Changes' : 'Add Book'}</button>
          </div>
        </div>`;
    }

    function render() {
      const app = document.getElementById('app');
      if (view === 'edit') app.innerHTML = renderEdit();
      else app.innerHTML = renderList();
    }

    loadBooks();
  </script>
</body>
</html>
